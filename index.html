<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart AI Grading System</title>
    
    <!-- 
    ===================================================================
    ğŸ“‹ ì„¤ì • ê°€ì´ë“œ - ë³¸ì¸ì˜ Google ê³„ì •ì— ì—°ë™í•˜ê¸°
    ===================================================================
    
    ì´ íŒŒì¼ì„ ë³¸ì¸ì˜ Google ê³„ì •ì— ì—°ë™í•˜ë ¤ë©´ ë‹¤ìŒ 3ê°€ì§€ ê°’ì„ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤:
    
    1. CLIENT_ID (ì•½ 11ë²ˆì§¸ ì¤„)
       - Google Cloud Consoleì—ì„œ OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ ID ë°œê¸‰
       - ê²½ë¡œ: Google Cloud Console > API ë° ì„œë¹„ìŠ¤ > ì‚¬ìš©ì ì¸ì¦ ì •ë³´ > OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ ID
    
    2. API_KEY (ì•½ 22ë²ˆì§¸ ì¤„)
       - Google Cloud Consoleì—ì„œ API í‚¤ ë°œê¸‰
       - ê²½ë¡œ: Google Cloud Console > API ë° ì„œë¹„ìŠ¤ > ì‚¬ìš©ì ì¸ì¦ ì •ë³´ > API í‚¤
    
    3. APPS_CRIPT_URL (ì•½ 27ë²ˆì§¸ ì¤„)
       - Google Apps Scriptë¥¼ ì›¹ ì•±ìœ¼ë¡œ ë°°í¬í•œ í›„ ë°›ì€ URL
       - ê²½ë¡œ: Apps Script í¸ì§‘ê¸° > ë°°í¬ > ìƒˆ ë°°í¬ > ì›¹ ì•±ìœ¼ë¡œ ë°°í¬ > ì‹¤í–‰ URL ë³µì‚¬
    
    4. HTMLì˜ data-client_id (ì•½ 922ë²ˆì§¸ ì¤„)
       - ìœ„ì˜ CLIENT_IDì™€ ë™ì¼í•œ ê°’ì„ ì…ë ¥
    
    âš ï¸ ì¤‘ìš”: Google Cloud Consoleì—ì„œ ë‹¤ìŒ APIë¥¼ í™œì„±í™”í•´ì•¼ í•©ë‹ˆë‹¤:
       - Google Sheets API
       - Gmail API
       - Google Apps Script API
    
    ===================================================================
    -->
    
    <!-- Google Helper Functions (Moved to Head) -->
    <script>
        // ============================================
        // ğŸ”§ ì‚¬ìš©ì ì„¤ì • ì˜ì—­ - ì—¬ê¸°ì— ë³¸ì¸ì˜ Google API ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”
        // ============================================
        
        // ğŸ“Œ Google Cloud Consoleì—ì„œ ë°œê¸‰ë°›ì€ ì›¹ í´ë¼ì´ì–¸íŠ¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”
        //    Google Cloud Console > API ë° ì„œë¹„ìŠ¤ > ì‚¬ìš©ì ì¸ì¦ ì •ë³´ > OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ ID
        //    ì˜ˆì‹œ: '123456789-abcdefghijklmnopqrstuvwxyz.apps.googleusercontent.com'
        const CLIENT_ID = '837113843065-r43b5g2f283ma3393nke4fcf25v0afi8.apps.googleusercontent.com';
        
        // ğŸ“Œ Google Cloud Consoleì—ì„œ ë°œê¸‰ë°›ì€ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”
        //    Google Cloud Console > API ë° ì„œë¹„ìŠ¤ > ì‚¬ìš©ì ì¸ì¦ ì •ë³´ > API í‚¤
        //    ì˜ˆì‹œ: 'AIzaSyAbCdEfGhIjKlMnOpQrStUvWxYz1234567'
        const API_KEY = 'AIzaSyAZ93RRH3OWFFp0stUEXNtnNHZPDgcaMIM';
        
        // ğŸ“Œ Google Apps Scriptë¥¼ ë°°í¬í•œ í›„ ë°›ì€ ì›¹ ì•± URLì„ ì…ë ¥í•˜ì„¸ìš”
        //    Apps Script í¸ì§‘ê¸° > ë°°í¬ > ìƒˆ ë°°í¬ > ì›¹ ì•±ìœ¼ë¡œ ë°°í¬ > ì‹¤í–‰ URL ë³µì‚¬
        //    ì˜ˆì‹œ: 'https://script.google.com/macros/s/AKfycbz.../exec'
        const APPS_CRIPT_URL = "https://script.google.com/macros/s/AKfycbzcfBkz33ebfffmdCa9_kaqo8Ngd_2STlvQN3uF4ySzkAz54Vu_VQUquL2fdRrBghAO/exec";
        
        // í•™ìƒ ë§í¬ì˜ appsScriptUrl íŒŒë¼ë¯¸í„°ë¡œ ë®ì–´ì“¸ URL (ê°™ì€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ìš©)
        let studentAppsScriptUrl = '';
        function getAppsScriptUrl() { return studentAppsScriptUrl || APPS_CRIPT_URL; }
        
        // ============================================
        // ğŸ”§ ì„¤ì • ì˜ì—­ ë
        // ============================================
        
        // Google API Discovery Docs ë° Scopes (ì¼ë°˜ì ìœ¼ë¡œ ìˆ˜ì • ë¶ˆí•„ìš”)
        const DISCOVERY_DOCS = [
            'https://sheets.googleapis.com/$discovery/rest?version=v4',
            'https://gmail.googleapis.com/$discovery/rest?version=v1'
        ];
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/gmail.send';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let spreadsheetId = localStorage.getItem('grading_spreadsheet_id') || '';

        // State Management
        let currentUser = null;
        let questions = [];

        // Initialize Google API
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // defined later
            });
            gisInited = true;
            maybeEnableButtons();
        }

        async function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                console.log("Google API Initialized");
                
                // í•™ìƒ ë§í¬ê°€ ìˆìœ¼ë©´ ë¡œê·¸ì¸ ìƒíƒœ ë³µì›í•˜ì§€ ì•ŠìŒ
                const urlParams = new URLSearchParams(window.location.search);
                const quizId = urlParams.get('quiz');
                if (!quizId) {
                    // í•™ìƒ ë§í¬ê°€ ì—†ì„ ë•Œë§Œ ë¡œê·¸ì¸ ìƒíƒœ ë³µì› ì‹œë„
                    await restoreLoginState();
                }
            }
        }

        async function restoreLoginState() {
            try {
                // í•™ìƒ ë§í¬ê°€ ìˆìœ¼ë©´ ë¡œê·¸ì¸ ìƒíƒœ ë³µì›í•˜ì§€ ì•ŠìŒ
                const urlParams = new URLSearchParams(window.location.search);
                const quizId = urlParams.get('quiz');
                if (quizId) {
                    console.log("Student link detected, skipping login state restoration");
                    return false;
                }
                
                // ì €ì¥ëœ í† í° í™•ì¸
                const savedToken = localStorage.getItem('google_access_token');
                const savedUser = localStorage.getItem('google_user');
                
                if (savedToken && savedUser) {
                    try {
                        // í† í°ì´ ìœ íš¨í•œì§€ í™•ì¸
                        gapi.client.setToken({ access_token: savedToken });
                        
                        // í† í° ìœ íš¨ì„± ê²€ì¦ (ê°„ë‹¨í•œ API í˜¸ì¶œ)
                        await gapi.client.load('oauth2', 'v2');
                        const userInfo = await gapi.client.oauth2.userinfo.get();
                        
                        // ìœ íš¨í•œ í† í°ì´ë©´ ë¡œê·¸ì¸ ìƒíƒœ ë³µì›
                        if (userInfo && userInfo.result) {
                            currentUser = JSON.parse(savedUser);
                            console.log("Login state restored for:", currentUser.email);
                            
                            // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì„¤ì • ë° ëŒ€ì‹œë³´ë“œ í‘œì‹œ
                            await setupSpreadsheet();
                            showTeacherDashboard();
                            return true;
                        }
                    } catch (tokenError) {
                        console.log("Saved token is invalid, clearing storage");
                        // í† í°ì´ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì €ì¥ëœ ì •ë³´ ì‚­ì œ
                        localStorage.removeItem('google_access_token');
                        localStorage.removeItem('google_user');
                    }
                }
                
                // ê¸°ì¡´ í† í° í™•ì¸ (gapi.client.getToken)
                const existingToken = gapi.client.getToken();
                if (existingToken) {
                    try {
                        await gapi.client.load('oauth2', 'v2');
                        const userInfo = await gapi.client.oauth2.userinfo.get();
                        
                        if (userInfo && userInfo.result) {
                            currentUser = {
                                email: userInfo.result.email,
                                name: userInfo.result.name,
                                picture: userInfo.result.picture,
                                role: 'teacher'
                            };
                            
                            // í† í° ì €ì¥
                            localStorage.setItem('google_access_token', existingToken.access_token);
                            localStorage.setItem('google_user', JSON.stringify(currentUser));
                            
                            await setupSpreadsheet();
                            showTeacherDashboard();
                            return true;
                        }
                    } catch (error) {
                        console.log("Existing token validation failed:", error);
                    }
                }
            } catch (error) {
                console.error("Error restoring login state:", error);
            }
            return false;
        }

        function handleCredentialResponse(response) {
            console.log("Encoded JWT ID token: " + response.credential);
            const responsePayload = decodeJwtResponse(response.credential);

            currentUser = {
                email: responsePayload.email,
                name: responsePayload.name,
                picture: responsePayload.picture,
                role: 'teacher'
            };

            if (!tokenClient) {
                // If this happens, it means GIS loaded but tokenClient wasn't set up? 
                // Should not happen with onload ordering, but good to check.
                console.warn("tokenClient not ready yet.");
                return;
            }
            requestAccessToken();
        }

        function decodeJwtResponse(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        function requestAccessToken() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    console.error("Auth Error", resp);
                    alert("ì¸ì¦ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + JSON.stringify(resp));
                    throw (resp);
                }
                console.log("Access Token Received");
                
                // í† í° ì €ì¥
                const token = gapi.client.getToken();
                if (token && token.access_token) {
                    localStorage.setItem('google_access_token', token.access_token);
                    
                    // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ë° ì €ì¥
                    try {
                        await gapi.client.load('oauth2', 'v2');
                        const userInfo = await gapi.client.oauth2.userinfo.get();
                        if (userInfo && userInfo.result) {
                            currentUser = {
                                email: userInfo.result.email,
                                name: userInfo.result.name,
                                picture: userInfo.result.picture,
                                role: 'teacher'
                            };
                            localStorage.setItem('google_user', JSON.stringify(currentUser));
                        }
                    } catch (userError) {
                        console.error("Error getting user info:", userError);
                    }
                }
                
                try {
                    await setupSpreadsheet();
                    showTeacherDashboard();
                } catch (err) {
                    console.error("Spreadsheet Setup Error", err);
                    alert("ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.\n" + (err.result?.error?.message || err.message));
                }
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }

        // Functions defined below (setupSpreadsheet, etc.) are available since they are var-hoisted or function declarations
        // but to be safe, we'll keep the core logic/UI stuff in the body script or move it all here.
        // For now, moving ONLY the init/auth stuff here is enough to catch the onload.
    </script>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
    <!-- Google API Client -->
    <script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>

    <!-- Google Fonts for Premium Look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Pastel/Neon Theme - GitHub inspired */
            --primary: #a78bfa;
            --primary-dark: #8b5cf6;
            --secondary: #f0abfc;
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --text-light: #c9d1d9;
            --text-gray: #8b949e;
            --success: #7ee787;
            --danger: #ff7b72;
            --glass: rgba(22, 27, 34, 0.7);

            /* Alias for consistency */
            --card-bg: var(--bg-card);
            --bg-color: var(--bg-dark);
            --text-color: var(--text-light);
            --secondary-color: var(--text-gray);
            --primary-color: var(--primary);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        /* ìš°ì¸¡ ìŠ¬ë¼ì´ë”© íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .slide-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 900px;
            max-width: 95vw;
            height: 100vh;
            background: var(--bg-card);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            transition: right 0.3s ease-in-out;
            overflow-y: auto;
            overflow-x: auto;
            padding: 2rem;
        }

        .slide-panel.active {
            right: 0;
        }

        .slide-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .slide-panel-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* í•™ìƒ ì‘ë‹µ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .answers-table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .answers-table th,
        .answers-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .answers-table th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: bold;
            color: var(--primary);
        }

        .answers-table th button {
            background: none;
            border: none;
            color: var(--primary);
            font-weight: bold;
            padding: 0;
            width: 100%;
            text-align: left;
            cursor: pointer;
        }

        .answers-table th button:hover {
            color: var(--accent);
        }

        .answers-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .answer-cell {
            max-width: 400px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        @media (max-width: 1024px) {
            .slide-panel {
                width: 95vw;
            }
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-center {
            justify-content: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .w-full {
            width: 100%;
        }

        .max-w-4xl {
            max-width: 56rem;
        }

        .p-4 {
            padding: 1rem;
        }

        .p-8 {
            padding: 2rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        .rounded-lg {
            border-radius: 0.5rem;
        }

        .text-center {
            text-align: center;
        }

        .font-bold {
            font-weight: 700;
        }

        .text-xl {
            font-size: 1.25rem;
        }

        .text-2xl {
            font-size: 1.5rem;
        }

        .text-3xl {
            font-size: 1.875rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mt-2 {
            margin-top: 0.5rem;
        }

        .mr-2 {
            margin-right: 0.5rem;
        }

        .ml-2 {
            margin-left: 0.5rem;
        }

        /* Missing Layout Utilities */
        .w-64 {
            width: 16rem;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .flex-wrap {
            flex-wrap: wrap;
        }

        .grid {
            display: grid;
        }

        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        @media (min-width: 768px) {
            .md\:grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        /* Missing Color/Visual Utilities */
        .text-white {
            color: #ffffff;
        }

        .text-accent {
            color: var(--secondary);
        }

        .bg-white-5 {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .bg-white-10 {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .hover\:bg-white-10:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .border-white-10 {
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pt-2 {
            padding-top: 0.5rem;
        }

        .pt-4 {
            padding-top: 1rem;
        }

        .pb-4 {
            padding-bottom: 1rem;
        }

        .border-t {
            border-top-width: 1px;
            border-style: solid;
        }

        /* Premium Components */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.5);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
        }

        button[onclick="showStudentLogin()"] {
            width: 220px;
            margin-top: 0px;
        }

        /* Google Sheets Green Neon Button */
        .btn-google-sheets {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5), 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .btn-google-sheets:hover {
            background: linear-gradient(135deg, #059669, #047857);
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.7), 0 10px 15px -3px rgba(0, 0, 0, 0.4);
            transform: translateY(-2px);
        }

        /* í´ë” ë§í¬ ë³µì‚¬ ë²„íŠ¼ í…Œë‘ë¦¬ ì œê±° */
        button[onclick*="copyFolderLink"] {
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
        }

        button[onclick*="copyFolderLink"]:hover {
            border: none !important;
            outline: none !important;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 1rem;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            width: 450px !important;
        }

        #student-login-view .card {
            width: 450px !important;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        label {
            color: var(--text-gray);
            font-size: 0.875rem;
            font-weight: 500;
        }

        input,
        select,
        textarea {
            background-color: rgba(0, 0, 0, 0.1);
            /* transparent-ish */
            border: 1px solid var(--secondary-color);
            color: var(--text-color);
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        /* Theme-specific styles */
        [data-theme="light"] {
            --bg-dark: #f6f8fa;
            --bg-card: #ffffff;
            --text-light: #24292f;
            --text-gray: #57606a;
            --primary: #a78bfa;
            --primary-dark: #8b5cf6;
            --secondary: #f0abfc;
            --success: #7ee787;
            --danger: #ff7b72;
        }

        [data-theme="light"] input,
        [data-theme="light"] select,
        [data-theme="light"] textarea {
            background-color: #ffffff;
            color: #24292f;
            border: 1px solid #d0d7de;
        }

        [data-theme="light"] input:focus,
        [data-theme="light"] select:focus,
        [data-theme="light"] textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.1);
        }

        /* Enhanced shadows for depth */
        .card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.2);
        }

        [data-theme="light"] .card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
        }

        /* Light theme buttons - pastel tones */
        [data-theme="light"] .btn-primary {
            background: linear-gradient(135deg, #a78bfa, #8b5cf6);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(167, 139, 250, 0.3);
        }

        [data-theme="light"] .btn-primary:hover {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            box-shadow: 0 10px 15px -3px rgba(167, 139, 250, 0.4);
        }

        [data-theme="light"] .btn-secondary {
            background: rgba(240, 171, 252, 0.2);
            color: var(--text-light);
            border: 1px solid rgba(240, 171, 252, 0.3);
            box-shadow: 0 4px 6px -1px rgba(240, 171, 252, 0.2);
        }

        [data-theme="light"] .btn-secondary:hover {
            background: rgba(240, 171, 252, 0.3);
            border-color: rgba(240, 171, 252, 0.5);
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* Specific Views */
        #login-view {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at top right, #1e1b4b, var(--bg-color));
        }

        .dashboard-grid {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 250px;
            background-color: var(--card-bg);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        #quiz-setup-grid {
            gap: 3rem;
        }

        @media (min-width: 768px) {
            #quiz-setup-grid {
                grid-template-columns: minmax(400px, 1.67fr) minmax(400px, 1.67fr);
                gap: 5rem;
                max-width: 95%;
            }

            #quiz-setup-grid .card {
                min-width: 0;
                width: 100% !important;
                max-width: none;
            }
        }

        /* Results Tab Layout */
        #results-stats-container {
            gap: 1.5rem;
            margin: 1rem 0 2rem 0;
            justify-content: flex-start;
            width: 100%;
        }

        .results-stat-card {
            flex: 0 0 calc(25% - 0.75rem);
            min-width: 200px;
            max-width: 300px;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }

        #tab-results {
            width: 100%;
            max-width: 100%;
            margin-left: -2rem;
            margin-right: -2rem;
            padding-left: 2rem;
            padding-right: 2rem;
        }

        .results-folders-card {
            width: calc(100% - 4rem) !important;
            max-width: calc(100% - 4rem) !important;
            margin: 1rem 0 1rem 0;
            padding: 1.5rem;
            box-sizing: border-box;
        }

        #folder-detail-view {
            width: calc(100% - 4rem) !important;
            max-width: calc(100% - 4rem) !important;
            margin: 1rem 0 1rem 0;
            padding: 1.5rem;
            box-sizing: border-box;
        }

        @media (max-width: 768px) {
            .results-stat-card {
                flex: 0 0 calc(50% - 0.75rem);
            }

            #results-stats-container {
                margin: 0.5rem 0;
            }

            .results-folders-card,
            #folder-detail-view {
                width: 100%;
                margin: 1rem 0;
            }
        }

        .nav-item {
            padding: 1rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }

        .nav-item:hover,
        .nav-item.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* Theme Selector */
        #theme-selector {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            z-index: 100;
            background: var(--card-bg);
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--secondary-color);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        /* Loading Animation */
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            padding: 2rem;
        }

        .loading-donut {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .result-card {
            margin-top: 1rem;
            padding: 1.5rem;
            border-radius: 0.5rem;
            background: var(--card-bg);
            border: 2px solid var(--primary);
        }

        .result-correct {
            border-color: var(--success);
            background: rgba(126, 231, 135, 0.15);
        }

        .result-incorrect {
            border-color: var(--danger);
            background: rgba(255, 123, 114, 0.15);
        }
    </style>
</head>

<body>

    <!-- Login View -->
    <div id="login-view" class="fade-in flex justify-center items-center h-screen">
        <div class="card text-center max-w-md w-full mx-auto shadow-2xl">
            <h1 class="text-3xl font-bold mb-4"
                style="background: linear-gradient(to right, #818cf8, #c084fc); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                Smart AI Grading
            </h1>
            <p class="text-gray mb-8">êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”.</p>

            <div class="flex flex-col gap-4 items-center">
                <!-- 
                ğŸ“Œ Google Sign-In ë²„íŠ¼ ì„¤ì •
                âš ï¸ ì¤‘ìš”: ìœ„ì˜ CLIENT_ID (ì•½ 17ë²ˆì§¸ ì¤„)ì™€ ë™ì¼í•œ ê°’ì„ ì—¬ê¸°ì—ë„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤!
                -->
                <div id="g_id_onload"
                    data-client_id="837113843065-r43b5g2f283ma3393nke4fcf25v0afi8.apps.googleusercontent.com"
                    data-callback="handleCredentialResponse" data-auto_select="false">
                </div>
                <div class="g_id_signin" data-type="standard" data-size="large" data-theme="filled_blue"
                    data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left">
                </div>

                <button onclick="showStudentLogin()" class="btn btn-secondary w-full mt-4">
                    í•™ìƒìœ¼ë¡œ ì‹œì‘í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- Student Login View (Simple) -->
    <div id="student-login-view" class="hidden fade-in"
        style="height: 100vh; display: flex; align-items: center; justify-content: center;">
        <div class="card max-w-md w-full">
            <h2 class="text-2xl font-bold mb-4 text-center">í•™ìƒ ë¡œê·¸ì¸</h2>
            <div class="input-group">
                <label>í•™ë²ˆ</label>
                <input type="text" id="student-id" placeholder="ì˜ˆ: 30101">
            </div>
            <div class="input-group">
                <label>ì´ë¦„</label>
                <input type="text" id="student-name" placeholder="í™ê¸¸ë™">
            </div>
            <button onclick="startStudentQuiz()" class="btn btn-primary w-full mt-4">í€´ì¦ˆ ì‹œì‘í•˜ê¸°</button>
            <button onclick="showLogin()" class="btn btn-secondary w-full mt-2">ë’¤ë¡œê°€ê¸°</button>
        </div>
    </div>

    <!-- Student Quiz View -->
    <div id="student-quiz-view" class="hidden fade-in p-8 max-w-4xl mx-auto">
        <h2 class="text-2xl font-bold mb-6 text-center">Quiz Time</h2>
        <div id="student-questions-container" class="space-y-6">
            <!-- Questions rendered here -->
        </div>

        <div class="card mt-8">
            <h3 class="text-xl mb-4">ì œì¶œ ì„¤ì •</h3>
            <div class="flex items-center gap-4 mb-4">
                <input type="checkbox" id="request-feedback" onchange="toggleEmailInput()">
                <label for="request-feedback" class="mb-0">ì±„ì  ê²°ê³¼ ë° í”¼ë“œë°± ì´ë©”ì¼ë¡œ ë°›ê¸°</label>
            </div>
            <div id="email-input-section" class="input-group hidden">
                <label>ì´ë©”ì¼ ì£¼ì†Œ</label>
                <input type="email" id="student-email" placeholder="example@gmail.com">
            </div>
            <button onclick="submitQuiz()" class="btn btn-success w-full text-lg">ë‹µì•ˆ ì œì¶œí•˜ê¸°</button>
        </div>
    </div>

    <!-- Teacher Dashboard -->
    <div id="teacher-dashboard" class="hidden dashboard-grid">
        <div class="sidebar">
            <h2 class="text-xl font-bold mb-8 p-2">Teacher Mode</h2>
            <div class="nav-item active" onclick="switchTab('quiz-setup')">ë¬¸ì œ ì¶œì œ</div>
            <div class="nav-item" onclick="switchTab('results')">ê²°ê³¼ ë° ì±„ì </div>
            <div class="nav-item text-success" onclick="openSpreadsheet()">ğŸ“Š ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸°</div>
            <div class="px-2 py-2 mt-2 border-t border-white/10">
                <label class="text-xs text-gray block mb-1">Apps Script ì›¹ì•± URL</label>
                <input type="text" id="teacher-apps-script-url" placeholder="ì›¹ì•± ë°°í¬ URL" class="w-full text-xs p-2 rounded bg-black/20 border border-white/10 mb-1" style="font-size: 11px;">
                <button type="button" onclick="saveTeacherAppsScriptUrl()" class="btn btn-secondary text-xs w-full py-1">URL ì €ì¥</button>
                <p class="text-xs text-gray mt-1">ë¬¸ì œ ì €ì¥ìš© ì‹œíŠ¸ì™€ ë™ì¼í•œ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë°°í¬í•œ URLì„ ì…ë ¥í•˜ì„¸ìš”.</p>
            </div>
            <div class="mt-auto pt-8">
                <div class="nav-item text-danger" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</div>
            </div>
        </div>

        <div class="main-content">
            <!-- Quiz Setup Tab -->
            <div id="tab-quiz-setup" class="fade-in">
                <h2 class="text-2xl font-bold mb-6">ë¬¸ì œ ì¶œì œ</h2>
                <div id="quiz-setup-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <h3 class="text-xl mb-4">ë¬¸ì œ ì…ë ¥</h3>

                        <div class="input-group">
                            <label>ë¬¸ì œ ê·¸ë£¹ (í´ë”ëª…)</label>
                            <input type="text" id="question-group" placeholder="ì˜ˆ: 1í•™ê¸° ì¤‘ê°„ê³ ì‚¬, ìˆ˜í•™ 1ë‹¨ì› ë“±">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="input-group">
                                <label>ìœ í˜•</label>
                                <select id="question-type" onchange="toggleQuestionInputs()">
                                    <option value="choice">ì„ íƒí˜•</option>
                                    <option value="short">ë‹¨ë‹µí˜•</option>
                                    <option value="essay">ì„œë…¼ìˆ í˜•</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>ë°°ì </label>
                                <input type="number" id="question-points" placeholder="ì˜ˆ: 5">
                            </div>
                        </div>

                        <div class="input-group">
                            <label>ë¬¸ì œ ë‚´ìš©</label>
                            <textarea id="question-content" rows="3" placeholder="ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>

                        <!-- Options for Choice -->
                        <div id="options-container" class="input-group">
                            <label>ì„ íƒì§€ (ì˜µì…˜ ì¶”ê°€)</label>
                            <div id="options-list" class="space-y-2 mb-2 gap-6">
                                <!-- Dynamic Options -->
                            </div>
                            <button onclick="addOption()" class="btn btn-secondary text-sm w-full">+ ì„ íƒì§€ ì¶”ê°€</button>
                        </div>

                        <div class="input-group">
                            <label>ì •ë‹µ</label>
                            <input type="text" id="question-answer" placeholder="ì •ë‹µ ì…ë ¥ (ì„ íƒí˜•ì€ ë²ˆí˜¸ í˜¹ì€ ë‚´ìš©)">
                        </div>

                        <!-- 5-Scale Rubric for Essay -->
                        <div id="rubric-container" class="input-group hidden">
                            <label class="text-accent mb-2 block">AI ì±„ì  ê¸°ì¤€ (5ë‹¨ê³„ ì²™ë„)</label>
                            <div class="space-y-3">
                                <div class="flex gap-2 items-center">
                                    <input type="number" id="rubric-points-5" placeholder="ë°°ì " class="w-20" min="0"
                                        max="100">
                                    <input type="text" id="rubric-5" class="flex-1"
                                        placeholder="5ì  ê¸°ì¤€ (íƒì›”): ì˜ˆ) í•µì‹¬ í‚¤ì›Œë“œ 3ê°œ ëª¨ë‘ í¬í•¨...">
                                </div>
                                <div class="flex gap-2 items-center">
                                    <input type="number" id="rubric-points-4" placeholder="ë°°ì " class="w-20" min="0"
                                        max="100">
                                    <input type="text" id="rubric-4" class="flex-1"
                                        placeholder="4ì  ê¸°ì¤€ (ìš°ìˆ˜): ì˜ˆ) í•µì‹¬ í‚¤ì›Œë“œ 2ê°œ í¬í•¨...">
                                </div>
                                <div class="flex gap-2 items-center">
                                    <input type="number" id="rubric-points-3" placeholder="ë°°ì " class="w-20" min="0"
                                        max="100">
                                    <input type="text" id="rubric-3" class="flex-1"
                                        placeholder="3ì  ê¸°ì¤€ (ë³´í†µ): ì˜ˆ) í•µì‹¬ í‚¤ì›Œë“œ 1ê°œ í¬í•¨...">
                                </div>
                                <div class="flex gap-2 items-center">
                                    <input type="number" id="rubric-points-2" placeholder="ë°°ì " class="w-20" min="0"
                                        max="100">
                                    <input type="text" id="rubric-2" class="flex-1"
                                        placeholder="2ì  ê¸°ì¤€ (ë¯¸í¡): ì˜ˆ) ê´€ë ¨ ë‚´ìš©ì´ë‚˜ í‚¤ì›Œë“œ ëˆ„ë½...">
                                </div>
                                <div class="flex gap-2 items-center">
                                    <input type="number" id="rubric-points-1" placeholder="ë°°ì " class="w-20" min="0"
                                        max="100">
                                    <input type="text" id="rubric-1" class="flex-1"
                                        placeholder="1ì  ê¸°ì¤€ (ë¶€ì¡±): ì˜ˆ) ë‚´ìš© ë¶ˆì¼ì¹˜...">
                                </div>
                            </div>
                        </div>

                        <div class="input-group hidden" id="old-criteria-group">
                            <!-- Legacy support or hidden -->
                        </div>

                        <div class="input-group">
                            <label>í•´ì„¤</label>
                            <textarea id="question-explanation" rows="2" placeholder="í•´ì„¤ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>

                        <button onclick="addQuestion()" class="btn btn-primary w-full">ë¬¸ì œ ì¶”ê°€í•˜ê¸°</button>
                    </div>

                    <div class="card">
                        <h3 class="text-xl mb-4">ì¶œì œëœ ë¬¸ì œ ëª©ë¡</h3>
                        <div id="questions-list">
                            <!-- Questions will be listed here -->
                            <div class="p-4 border border-white/10 rounded mb-2">
                                ì•„ì§ ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.
                            </div>
                        </div>
                        <button onclick="saveToSheets()" class="btn btn-google-sheets w-full mt-4">
                            ğŸ’¾ êµ¬ê¸€ ì‹œíŠ¸ì— ì €ì¥ & í•™ìƒì—ê²Œ ë‚´ë³´ë‚´ê¸°
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Tab -->
            <div id="tab-results" class="hidden fade-in">
                <h2 class="text-2xl font-bold mb-12">ì±„ì  ë° ê²°ê³¼</h2>
                <div id="results-stats-container" class="flex gap-6 mb-16">
                    <div class="card results-stat-card">
                        <h3 class="text-gray mb-2">ì œì¶œëœ ë‹µì•ˆ</h3>
                        <p id="total-submissions" class="text-3xl font-bold" style="border: none;">0</p>
                    </div>
                    <div class="card results-stat-card">
                        <h3 class="text-gray mb-2">ì±„ì  ì™„ë£Œ</h3>
                        <p id="total-graded" class="text-3xl font-bold" style="border: none;">0</p>
                    </div>
                </div>

                <div class="card results-folders-card mb-16">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl">ë¬¸í•­ë³„ í´ë”</h3>
                        <div class="flex gap-2">
                            <button onclick="refreshDashboard()" class="btn btn-secondary">ìƒˆë¡œê³ ì¹¨</button>
                        </div>
                    </div>
                    <div id="folders-container" class="flex flex-wrap gap-6">
                        <!-- Question Folders -->
                    </div>
                </div>

                <!-- Expanded Folder View (Hidden by default) -->
                <div id="folder-detail-view" class="hidden card mt-16">
                    <div class="flex justify-between mb-6">
                        <h3 id="folder-title" class="text-xl font-bold">Q_ID Detail</h3>
                        <button onclick="closeFolder()" class="btn btn-secondary text-sm">ë‹«ê¸°</button>
                    </div>
                    <div id="folder-answers-list" class="space-y-6"></div>
                </div>
            </div>
        </div>

        <!-- JS Logic -->
        <script>
            // Google API Config - MOVED TO HEAD
            // The functions gapiLoaded, gisLoaded, initializeGapiClient, checkGapi, etc. 
            // are now in the head to support onload callbacks.

            // Sheets Logic
            async function setupSpreadsheet() {
                if (!spreadsheetId) {
                    try {
                        const response = await gapi.client.sheets.spreadsheets.create({
                            resource: {
                                properties: {
                                    title: "Smart Grading System DB",
                                },
                            },
                        });
                        spreadsheetId = response.result.spreadsheetId;
                        localStorage.setItem('grading_spreadsheet_id', spreadsheetId);
                        console.log("Created Dashboard: " + spreadsheetId);

                        // New sheet needs headers
                        await ensureSheetsExist();

                    } catch (err) {
                        console.error("Error creating spreadsheet", err);
                        // Handle 403 Forbidden specifically?
                        throw err;
                    }
                } else {
                    try {
                        await ensureSheetsExist();
                    } catch (err) {
                        // If 404 (Not Found), maybe ID is invalid or deleted.
                        if (err.status === 404 || (err.result && err.result.error && err.result.error.code === 404)) {
                            if (confirm("ê¸°ì¡´ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì‚­ì œë¨?). ìƒˆë¡œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                                spreadsheetId = '';
                                localStorage.removeItem('grading_spreadsheet_id');
                                return setupSpreadsheet(); // Retry create
                            }
                        } else {
                            throw err;
                        }
                    }
                }
            }

            async function ensureSheetsExist() {
                // Check existing sheets
                try {
                    const response = await gapi.client.sheets.spreadsheets.get({
                        spreadsheetId: spreadsheetId,
                    });

                    const sheets = response.result.sheets;
                    const sheetTitles = sheets.map(s => s.properties.title);

                    const requiredSheets = ['Quiz', 'answer', 'SCORE'];
                    const requests = [];

                    requiredSheets.forEach(title => {
                        if (!sheetTitles.includes(title)) {
                            requests.push({
                                addSheet: {
                                    properties: {
                                        title: title
                                    }
                                }
                            });
                        }
                    });

                    if (requests.length > 0) {
                        await gapi.client.sheets.spreadsheets.batchUpdate({
                            spreadsheetId: spreadsheetId,
                            resource: {
                                requests: requests,
                            },
                        });
                        console.log("Created missing sheets");
                    }

                    // Initialize headers if needed (simplified)
                } catch (err) {
                    console.error("Error checking sheets", err);
                }
            }

            // Navigation Logic
            function showLogin() {
                // ëª¨ë“  í™”ë©´ ìˆ¨ê¸°ê¸°
                document.getElementById('teacher-dashboard').classList.add('hidden');
                document.getElementById('teacher-dashboard').classList.remove('flex');
                document.getElementById('student-login-view').classList.add('hidden');
                document.getElementById('student-quiz-view').classList.add('hidden');
                
                // ì¼ë°˜ ë¡œê·¸ì¸ í™”ë©´ë§Œ í‘œì‹œ
                document.getElementById('login-view').classList.remove('hidden');
            }

            function showStudentLogin() {
                // ëª¨ë“  êµì‚¬ ê´€ë ¨ í™”ë©´ ìˆ¨ê¸°ê¸°
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('teacher-dashboard').classList.add('hidden');
                document.getElementById('teacher-dashboard').classList.remove('flex');
                
                // í•™ìƒ ë¡œê·¸ì¸ í™”ë©´ë§Œ í‘œì‹œ
                document.getElementById('student-login-view').classList.remove('hidden');
                document.getElementById('student-quiz-view').classList.add('hidden');
            }

            function logout() {
                google.accounts.id.disableAutoSelect();
                currentUser = null;
                showLogin();
            }

            function showTeacherDashboard() {
                // ëª¨ë“  í•™ìƒ í™”ë©´ ìˆ¨ê¸°ê¸°
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('student-login-view').classList.add('hidden');
                document.getElementById('student-quiz-view').classList.add('hidden');
                
                // êµì‚¬ ëŒ€ì‹œë³´ë“œë§Œ í‘œì‹œ
                document.getElementById('teacher-dashboard').classList.remove('hidden');
                document.getElementById('teacher-dashboard').classList.add('flex');

                // Show quiz-setup tab by default
                document.getElementById('tab-quiz-setup').classList.remove('hidden');
                document.getElementById('tab-results').classList.add('hidden');

                // Load dashboard data for results tab (will be shown when user switches)
                loadDashboardData();

                var urlInput = document.getElementById('teacher-apps-script-url');
                if (urlInput) urlInput.value = localStorage.getItem('teacher_apps_script_url') || APPS_CRIPT_URL || '';

                // Auto-grade new submissions periodically
                setInterval(autoGradeNewSubmissions, 30000); // Check every 30 seconds
            }

            function saveTeacherAppsScriptUrl() {
                var input = document.getElementById('teacher-apps-script-url');
                if (!input) return;
                var url = (input.value || '').trim();
                if (!url) {
                    localStorage.removeItem('teacher_apps_script_url');
                    alert('Apps Script URLì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ URLì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                    return;
                }
                if (!url.startsWith('https://script.google.com/')) {
                    alert('ì˜¬ë°”ë¥¸ Google Apps Script ì›¹ì•± URLì„ ì…ë ¥í•˜ì„¸ìš”. (https://script.google.com/... ë¡œ ì‹œì‘)');
                    return;
                }
                localStorage.setItem('teacher_apps_script_url', url);
                alert('Apps Script URLì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì•ìœ¼ë¡œ ë³µì‚¬í•˜ëŠ” í´ë” ë§í¬ì— ì´ URLì´ í¬í•¨ë©ë‹ˆë‹¤.');
            }

            async function autoGradeNewSubmissions() {
                try {
                    // Reload answers to check for new submissions
                    const aRes = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: spreadsheetId,
                        range: 'answer!A2:G'
                    });

                    if (!aRes.result.values) return;

                    const newAnswers = aRes.result.values.map(r => ({
                        timestamp: r[0], sid: r[1], name: r[2], email: r[3], qId: r[4], answer: r[5], group: r[6] || ''
                    }));

                    // Reload scores (including EmailStatus column)
                    const sRes = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: spreadsheetId,
                        range: 'SCORE!A2:H'
                    });

                    const existingScores = sRes.result.values ? sRes.result.values.map(r => ({
                        sid: String(r[1]), qId: String(r[3])
                    })) : [];

                    // Find ungraded answers (íƒ€ì… ì¼ì¹˜ë¥¼ ìœ„í•´ Stringìœ¼ë¡œ ë³€í™˜)
                    const ungradedAnswers = newAnswers.filter(a =>
                        !existingScores.find(s => s.sid === String(a.sid) && s.qId === String(a.qId))
                    );

                    if (ungradedAnswers.length === 0) return;

                    // Reload questions
                    const qRes = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: spreadsheetId,
                        range: 'Quiz!A2:I'
                    });

                    if (!qRes.result.values) return;

                    const questions = qRes.result.values.map(r => ({
                        id: r[0],
                        group: r[1],
                        type: getQuestionTypeEnglish(r[2] || ''), // í•œê¸€/ì˜ì–´ ëª¨ë‘ ì²˜ë¦¬í•˜ì—¬ ì˜ì–´ë¡œ ì •ê·œí™” (ë‚´ë¶€ ì²˜ë¦¬ìš©)
                        points: r[3],
                        content: r[4],
                        answer: r[5],
                        options: r[6] ? (typeof r[6] === 'string' ? JSON.parse(r[6] || '[]') : r[6]) : [],
                        rubric: r[7] || '',
                        explanation: r[8] || ''
                    }));

                    // Grade ungraded answers
                    const newScores = [];
                    const timestamp = new Date().toISOString();

                    for (const a of ungradedAnswers) {
                        // íƒ€ì… ì¼ì¹˜ë¥¼ ìœ„í•´ Stringìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ
                        const q = questions.find(q => String(q.id) === String(a.qId));
                        if (!q) continue;
                        
                        // ì¤‘ë³µ ì²´í¬ (ì´ë¯¸ ì €ì¥ëœ ì ìˆ˜ê°€ ìˆëŠ”ì§€ ë‹¤ì‹œ í™•ì¸)
                        const alreadyGraded = existingScores.find(s => 
                            s.sid === String(a.sid) && s.qId === String(a.qId)
                        );
                        if (alreadyGraded) {
                            console.log(`Score already exists for ${a.sid}, Q${a.qId}, skipping...`);
                            continue;
                        }

                        let score = 0;
                        let feedback = "";

                        if (q.type === 'essay') {
                            try {
                                const res = await fetch('/.netlify/functions/grade', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        question: q.content,
                                        studentAnswer: a.answer,
                                        rubric: q.rubric,
                                        correctAnswer: q.answer,
                                        type: 'essay'
                                    })
                                });

                                // ì‘ë‹µ í…ìŠ¤íŠ¸ ë¨¼ì € ê°€ì ¸ì˜¤ê¸°
                                const responseText = await res.text();
                                
                                // ì‘ë‹µ ìƒíƒœ í™•ì¸
                                if (!res.ok) {
                                    console.error('AI Grading API Error:', res.status, responseText);
                                    
                                    // JSON í˜•ì‹ì˜ ì—ëŸ¬ ì‘ë‹µì¸ì§€ í™•ì¸
                                    let errorData;
                                    try {
                                        errorData = JSON.parse(responseText);
                                        if (errorData.error && errorData.score !== undefined) {
                                            score = errorData.score || 0;
                                            feedback = errorData.feedback || errorData.error || 'ì±„ì  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                                            continue; // ë‹¤ìŒ ë‹µì•ˆìœ¼ë¡œ
                                        }
                                    } catch (parseErr) {
                                        // JSONì´ ì•„ë‹Œ ê²½ìš°
                                    }
                                    
                                    throw new Error(`ì±„ì  API ì˜¤ë¥˜ (${res.status})`);
                                }

                                // JSON íŒŒì‹± ì‹œë„
                                let data;
                                try {
                                    data = JSON.parse(responseText);
                                } catch (parseError) {
                                    console.error('Failed to parse JSON response:', parseError);
                                    console.error('Response text:', responseText.substring(0, 500));
                                    throw new Error('ì±„ì  ì„œë²„ ì‘ë‹µì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                                }
                                
                                // ì—ëŸ¬ í•„ë“œê°€ ìˆì§€ë§Œ scoreì™€ feedbackë„ ìˆëŠ” ê²½ìš° ì²˜ë¦¬
                                if (data.error && data.score === undefined) {
                                    throw new Error(data.error || 'ì±„ì  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                                }
                                score = typeof data.score === 'number' ? data.score : 0;
                                feedback = typeof data.feedback === 'string' ? data.feedback : 'ì±„ì  ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                            } catch (e) {
                                console.error('AI Grading Error', e);
                                score = 0;
                                feedback = "AI ì±„ì  ì‹¤íŒ¨: " + (e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                            }
                        } else if (q.type === 'choice') {
                            // ì„ íƒí˜• ì±„ì  - ë²ˆí˜¸, ë‚´ìš©, ì„ íƒì§€ ì¸ë±ìŠ¤ ëª¨ë‘ ì§€ì›
                            const studentAns = a.answer.trim();
                            const correctAns = q.answer.trim();
                            const options = q.options || [];

                            // 1. ì§ì ‘ ë‚´ìš© ë¹„êµ
                            if (studentAns === correctAns) {
                                score = q.points;
                                feedback = "ì •ë‹µì…ë‹ˆë‹¤.";
                            } else {
                                // 2. ì„ íƒì§€ ì¸ë±ìŠ¤ë¡œ ë¹„êµ
                                const studentIndex = options.findIndex(opt => opt === studentAns);
                                const correctIndex = options.findIndex(opt => opt === correctAns);

                                if (studentIndex !== -1 && correctIndex !== -1 && studentIndex === correctIndex) {
                                    score = q.points;
                                    feedback = "ì •ë‹µì…ë‹ˆë‹¤.";
                                } else {
                                    // 3. ë²ˆí˜¸ë¡œ ë¹„êµ (ì •ë‹µì´ "1", "2" ê°™ì€ ê²½ìš°)
                                    const numPattern = /^(\d+)$/;
                                    if (numPattern.test(correctAns)) {
                                        const correctNum = parseInt(correctAns);
                                        if (studentIndex === correctNum - 1) {
                                            score = q.points;
                                            feedback = "ì •ë‹µì…ë‹ˆë‹¤.";
                                        } else {
                                            score = 0;
                                            feedback = `ì˜¤ë‹µì…ë‹ˆë‹¤. (ì •ë‹µ: ${correctAns}) ${q.explanation || ''}`;
                                        }
                                    } else {
                                        score = 0;
                                        feedback = `ì˜¤ë‹µì…ë‹ˆë‹¤. (ì •ë‹µ: ${correctAns}) ${q.explanation || ''}`;
                                    }
                                }
                            }
                        } else {
                            // ë‹¨ë‹µí˜• Simple Match Logic
                            if (a.answer.trim() === q.answer.trim()) {
                                score = q.points;
                                feedback = "ì •ë‹µì…ë‹ˆë‹¤.";
                            } else {
                                score = 0;
                                feedback = `ì˜¤ë‹µì…ë‹ˆë‹¤. (ì •ë‹µ: ${q.answer}) ${q.explanation || ''}`;
                            }
                        }

                        // ìœ í˜•ì„ í•œê¸€ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥
                        const typeKorean = getQuestionTypeName(q.type);
                        
                        // autoGradeAndSave í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¤‘ë³µ ì €ì¥ ë°©ì§€ (ë½ ë©”ì»¤ë‹ˆì¦˜ í¬í•¨)
                        await autoGradeAndSave(q.id, a.sid, a.name, score, feedback, typeKorean);
                    }

                    // Refresh dashboard if results tab is visible
                    if (!document.getElementById('tab-results').classList.contains('hidden')) {
                        loadDashboardData();
                    }
                } catch (err) {
                    console.error("Auto-grade error", err);
                }
            }

            let allAnswers = [];
            let allScores = [];
            let allQuestions = [];

            async function loadDashboardData() {
                try {
                    console.log("Loading Dashboard Data...");
                    // Load Questions - ì•±ìŠ¤í¬ë¦½íŠ¸ë¥¼ í†µí•´ ì¡°íšŒ (ë°°í¬ëœ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì™€ ë™ê¸°í™”)
                    let questionRows = [];
                    try {
                        const res = await fetch(getAppsScriptUrl() + '?type=quiz&spreadsheetId=' + encodeURIComponent(spreadsheetId));
                        const json = await res.json();

                        // Handle different possible return formats
                        if (json.data && Array.isArray(json.data)) questionRows = json.data;
                        else if (Array.isArray(json)) questionRows = json;
                        else if (json.values && Array.isArray(json.values)) questionRows = json.values;

                        console.log("Loaded questions via App Script", questionRows.length);
                    } catch (scriptErr) {
                        console.warn("App Script Load Failed, falling back to GAPI", scriptErr);

                        // Fallback to GAPI (Requires Public Sheet or User Login)
                        const qRes = await gapi.client.sheets.spreadsheets.values.get({
                            spreadsheetId: spreadsheetId,
                            range: 'Quiz!A2:I'
                        });
                        questionRows = qRes.result.values || [];
                    }

                    if (questionRows && questionRows.length > 0) {
                        allQuestions = questionRows.map(r => ({
                            id: r[0],
                            group: r[1],
                            type: getQuestionTypeEnglish(r[2] || ''), // í•œê¸€/ì˜ì–´ ëª¨ë‘ ì²˜ë¦¬í•˜ì—¬ ì˜ì–´ë¡œ ì •ê·œí™” (ë‚´ë¶€ ì²˜ë¦¬ìš©)
                            points: r[3],
                            content: r[4],
                            answer: r[5],
                            options: r[6] ? (typeof r[6] === 'string' ? JSON.parse(r[6] || '[]') : r[6]) : [],
                            rubric: r[7] || '',
                            explanation: r[8] || ''
                        }));
                    } else {
                        allQuestions = [];
                    }

                    // Load Answers (including Group column)
                    const aRes = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: spreadsheetId,
                        range: 'answer!A2:G'
                    });

                    if (aRes.result.values) {
                        allAnswers = aRes.result.values.map(r => ({
                            timestamp: r[0], sid: r[1], name: r[2], email: r[3], qId: r[4], answer: r[5], group: r[6] || ''
                        }));
                    } else {
                        allAnswers = [];
                    }

                    // Load Scores (including EmailStatus column)
                    const sRes = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: spreadsheetId,
                        range: 'SCORE!A2:H'
                    });

                    if (sRes.result.values) {
                        allScores = sRes.result.values.map(r => ({
                            sid: r[1], qId: r[3], score: r[4], feedback: r[5], emailStatus: r[7] || ''
                        }));
                    } else {
                        allScores = [];
                    }

                    console.log("Data Loaded:", {
                        questions: allQuestions.length,
                        answers: allAnswers.length,
                        scores: allScores.length
                    });

                    // DEBUG: Show user what happened
                    if (allQuestions.length === 0) {
                        alert("ë¡œë“œëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤ 'Quiz' ì‹œíŠ¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    } else if (allAnswers.length === 0) {
                        // This is expected if nobody submitted yet, but user said "answers are entering DB"
                        // So if this is 0, it means frontend is looking at WRONG sheet or WRONG range.
                        console.warn("No answers loaded.");
                    }

                    renderDashboard();
                } catch (err) {
                    console.error("Dashboard Load Error", err);
                    alert("ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
                }
            }

            function renderDashboard() {
                console.log("Rendering Dashboard...");

                // Update statistics
                const totalSubmissionsEl = document.getElementById('total-submissions');
                const totalGradedEl = document.getElementById('total-graded');
                if (totalSubmissionsEl) {
                    totalSubmissionsEl.textContent = allAnswers.length;
                }
                if (totalGradedEl) {
                    const gradedCount = allAnswers.filter(a =>
                        allScores.find(s => s.sid === a.sid && s.qId === a.qId)
                    ).length;
                    totalGradedEl.textContent = gradedCount;
                }

                const container = document.getElementById('folders-container');
                if (!container) {
                    console.error("Folders container not found!");
                    return;
                }

                if (allQuestions.length === 0) {
                    container.innerHTML = '<p class="text-gray col-span-3 text-center">ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ë¬¸ì œë¥¼ ë¨¼ì € ì¶œì œí•´ì£¼ì„¸ìš”.</p>';
                    return;
                }

                // Clear container before rendering
                container.innerHTML = '';

                // Cluster by Group
                const groups = [...new Set(allQuestions.map(q => q.group || 'ê¸°ë³¸ ê·¸ë£¹'))];

                if (groups.length === 0 && allQuestions.length > 0) groups.push('ê¸°ë³¸ ê·¸ë£¹');

                console.log("Groups to render:", groups);
                // alert(`ë Œë”ë§ ì‹œì‘: ${groups.length}ê°œ ê·¸ë£¹`); // User annoyance minimized, uncomment if needed.

                groups.forEach(groupName => {
                    // Counts
                    const groupQs = allQuestions.filter(q => (q.group || 'ê¸°ë³¸ ê·¸ë£¹') === groupName);
                    let totalSubmissions = 0;
                    let totalGraded = 0;

                    groupQs.forEach(q => {
                        const qAnswers = allAnswers.filter(a => a.qId === q.id);
                        totalSubmissions += qAnswers.length;
                        totalGraded += qAnswers.filter(a => allScores.find(s => s.sid === a.sid && s.qId === a.qId)).length;
                    });

                    console.log(`Rendering Group: ${groupName}, Qs: ${groupQs.length}, Subs: ${totalSubmissions}`);

                    const div = document.createElement('div');
                    div.className = 'card w-64 cursor-pointer hover:bg-white-10 transition flex flex-col justify-between';
                    div.onclick = () => openGroupFolder(groupName);

                    // Generate folder link (appsScriptUrl = ì´ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì—°ê²°ëœ ì›¹ì•± URLì´ì–´ì•¼ í•¨)
                    const folderLink = window.location.origin + (window.location.pathname || '/') + "?quiz=" + spreadsheetId + "&group=" + encodeURIComponent(groupName) + "&appsScriptUrl=" + encodeURIComponent(localStorage.getItem('teacher_apps_script_url') || APPS_CRIPT_URL);

                    // Folder Icon SVG
                    div.innerHTML = `
                    <div class="flex items-center gap-4 text-accent mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 32px; height: 32px; color: var(--primary);">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" />
                        </svg>
                        <h4 class="font-bold text-lg text-white">${groupName}</h4>
                    </div>
                    <p class="text-sm text-gray">ë¬¸ì œ ìˆ˜: ${groupQs.length}</p>
                    <div class="mt-4 flex justify-between text-sm pt-2" style="border: none;">
                        <span class="text-white">ì œì¶œ: ${totalSubmissions}</span>
                        <span class="text-white">ì±„ì : ${totalGraded}</span>
                    </div>
                    <div class="mt-4 pt-2">
                        <button onclick="event.stopPropagation(); copyFolderLink('${folderLink}', '${groupName}')" 
                                class="btn btn-secondary text-xs w-full" style="border: none !important; outline: none !important; box-shadow: none !important;">
                            ğŸ“‹ í´ë” ë§í¬ ë³µì‚¬
                        </button>
                    </div>
                `;
                    container.appendChild(div);
                });
            }

            // Revised detail view (Group -> Questions)
            function openGroupFolder(groupName) {
                // Filter questions by group
                const groupQs = allQuestions.filter(q => (q.group || 'ê¸°ë³¸ ê·¸ë£¹') === groupName);

                // Re-use logic to show question list inside the folder view??
                // The prompt says "Clicking the folder shows student responses FOR EACH ITEM" -> implication: show list of items, then click item to see responses.

                const detailView = document.getElementById('folder-detail-view');
                detailView.classList.remove('hidden');
                document.getElementById('folder-title').innerText = `ğŸ“‚ ${groupName}`;

                const list = document.getElementById('folder-answers-list');
                list.innerHTML = '';

                // Render list of questions in this group
                groupQs.forEach(q => {
                    // qId íƒ€ì… ì¼ì¹˜ë¥¼ ìœ„í•´ Stringìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ
                    const qAnswers = allAnswers.filter(a => String(a.qId) === String(q.id));
                    const gradedCount = qAnswers.filter(a => allScores.find(s => s.sid === a.sid && String(s.qId) === String(a.qId))).length;

                    const qDiv = document.createElement('div');
                    qDiv.className = 'p-4 border border-white/10 rounded bg-white/5 mb-6';
                    qDiv.innerHTML = `
                        <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <h5 class="font-bold text-lg">Q. ${q.content} (${q.points}ì )</h5>
                            <span class="text-xs text-gray ml-2">ìœ í˜•: ${getQuestionTypeName(q.type)}</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-sm">
                                <span class="mr-3">ì‘ë‹µ: ${qAnswers.length}</span>
                                <span class="text-success">ì™„ë£Œ: ${gradedCount}</span>
                            </div>
                            <button onclick="event.stopPropagation(); showAnswersTable('${q.id}')" 
                                    class="btn btn-secondary text-xs px-4 py-2">ğŸ“‹ ì‘ë‹µ ë³´ê¸°</button>
                            <button onclick="event.stopPropagation(); editQuestion('${q.id}')" 
                                    class="btn btn-secondary text-xs px-4 py-2">âœï¸ ìˆ˜ì •</button>
                            <button onclick="event.stopPropagation(); deleteQuestion('${q.id}', '${q.content.replace(/'/g, "\\'")}')" 
                                    class="btn btn-danger text-xs px-4 py-2">ğŸ—‘ï¸ ì‚­ì œ</button>
                        </div>
                    </div>
                 `;
                    list.appendChild(qDiv);

                    // ë‹µì•ˆ ì»¨í…Œì´ë„ˆëŠ” ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (ìš°ì¸¡ íŒ¨ë„ë¡œ ì´ë™)
                });
            }


            function closeFolder() {
                document.getElementById('folder-detail-view').classList.add('hidden');
            }

            // ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜ (í´ë”ê°€ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê³  ìƒˆë¡œê³ ì¹¨)
            async function refreshDashboard() {
                // í´ë”ê°€ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸
                const folderDetailView = document.getElementById('folder-detail-view');
                if (folderDetailView && !folderDetailView.classList.contains('hidden')) {
                    // í´ë”ê°€ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
                    closeFolder();
                    // ì•½ê°„ì˜ ë”œë ˆì´ í›„ ìƒˆë¡œê³ ì¹¨ (UI ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ)
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                await loadDashboardData();
            }

            // ë¬¸ì œ ìˆ˜ì • í•¨ìˆ˜
            async function editQuestion(questionId) {
                const question = allQuestions.find(q => String(q.id) === String(questionId));
                if (!question) {
                    alert("ë¬¸ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                // ê¸°ì¡´ íŒ¨ë„ì´ ìˆìœ¼ë©´ ì œê±°
                const existingPanel = document.getElementById('edit-question-panel');
                if (existingPanel) {
                    existingPanel.remove();
                }
                const existingOverlay = document.getElementById('edit-question-overlay');
                if (existingOverlay) {
                    existingOverlay.remove();
                }

                // ìš°ì¸¡ ìŠ¬ë¼ì´ë”© íŒ¨ë„ ìƒì„±
                const overlay = document.createElement('div');
                overlay.className = 'slide-panel-overlay';
                overlay.id = 'edit-question-overlay';
                overlay.onclick = closeEditModal;
                
                const panel = document.createElement('div');
                panel.className = 'slide-panel';
                panel.id = 'edit-question-panel';
                
                // ë¬¸ì œ ë°ì´í„°ë¥¼ í¼ì— ì±„ìš°ê¸°
                let optionsHtml = '';
                if (question.type === 'choice' && question.options) {
                    const options = typeof question.options === 'string' ? JSON.parse(question.options || '[]') : question.options;
                    options.forEach((opt, idx) => {
                        optionsHtml += `
                            <div class="flex gap-2 mb-2">
                                <input type="text" class="flex-1" value="${opt.replace(/"/g, '&quot;')}" id="edit-option-${idx}">
                                <button onclick="removeEditOption(${idx})" class="btn btn-danger text-xs">ì‚­ì œ</button>
                            </div>
                        `;
                    });
                }

                let rubricHtml = '';
                if (question.type === 'essay' && question.rubric) {
                    const rubric = typeof question.rubric === 'string' ? JSON.parse(question.rubric || '{}') : question.rubric;
                    for (let i = 5; i >= 1; i--) {
                        const rubricItem = rubric[i] || {};
                        rubricHtml += `
                            <div class="flex gap-2 items-center">
                                <input type="number" id="edit-rubric-points-${i}" placeholder="ë°°ì " class="w-20" min="0" max="100" value="${rubricItem.points || ''}">
                                <input type="text" id="edit-rubric-${i}" class="flex-1" value="${(rubricItem.criteria || '').replace(/"/g, '&quot;')}" placeholder="${i}ì  ê¸°ì¤€">
                            </div>
                        `;
                    }
                }

                panel.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold">ë¬¸ì œ ìˆ˜ì •</h3>
                        <button onclick="closeEditModal()" class="btn btn-secondary text-sm">âœ• ë‹«ê¸°</button>
                    </div>
                    <div class="space-y-4">
                        <div class="space-y-4">
                            <div class="input-group">
                                <label>í´ë”ëª…</label>
                                <input type="text" id="edit-question-group" value="${(question.group || '').replace(/"/g, '&quot;')}" placeholder="í´ë”ëª…">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="input-group">
                                    <label>ìœ í˜•</label>
                                    <select id="edit-question-type" onchange="toggleEditQuestionInputs()">
                                        <option value="choice" ${question.type === 'choice' ? 'selected' : ''}>ì„ íƒí˜•</option>
                                        <option value="short" ${question.type === 'short' ? 'selected' : ''}>ë‹¨ë‹µí˜•</option>
                                        <option value="essay" ${question.type === 'essay' ? 'selected' : ''}>ì„œë…¼ìˆ í˜•</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label>ë°°ì </label>
                                    <input type="number" id="edit-question-points" value="${question.points || ''}" placeholder="ì˜ˆ: 5">
                                </div>
                            </div>
                            <div class="input-group">
                                <label>ë¬¸ì œ ë‚´ìš©</label>
                                <textarea id="edit-question-content" rows="3" placeholder="ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”">${(question.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                            </div>
                            <div id="edit-options-container" class="input-group ${question.type === 'choice' ? '' : 'hidden'}">
                                <label>ì„ íƒì§€</label>
                                <div id="edit-options-list" class="space-y-2 mb-2">
                                    ${optionsHtml}
                                </div>
                                <button onclick="addEditOption()" class="btn btn-secondary text-sm w-full">+ ì„ íƒì§€ ì¶”ê°€</button>
                            </div>
                            <div class="input-group">
                                <label>ì •ë‹µ</label>
                                <input type="text" id="edit-question-answer" value="${(question.answer || '').replace(/"/g, '&quot;')}" placeholder="ì •ë‹µ ì…ë ¥">
                            </div>
                            <div id="edit-rubric-container" class="input-group ${question.type === 'essay' ? '' : 'hidden'}">
                                <label class="text-accent mb-2 block">AI ì±„ì  ê¸°ì¤€ (5ë‹¨ê³„ ì²™ë„)</label>
                                <div class="space-y-3">
                                    ${rubricHtml}
                                </div>
                            </div>
                            <div class="input-group">
                                <label>í•´ì„¤</label>
                                <textarea id="edit-question-explanation" rows="2" placeholder="í•´ì„¤ì„ ì…ë ¥í•˜ì„¸ìš”">${(question.explanation || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                            </div>
                        </div>
                        <div class="flex gap-4 mt-6">
                            <button onclick="saveEditedQuestion('${questionId}')" class="btn btn-primary flex-1">ì €ì¥</button>
                            <button onclick="closeEditModal()" class="btn btn-secondary flex-1">ì·¨ì†Œ</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
                document.body.appendChild(panel);
                
                // ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—° í›„ active í´ë˜ìŠ¤ ì¶”ê°€
                setTimeout(() => {
                    overlay.classList.add('active');
                    panel.classList.add('active');
                }, 10);
                
                // ì „ì—­ ë³€ìˆ˜ì— í¸ì§‘ ì¤‘ì¸ ì˜µì…˜ ì €ì¥
                window.editOptions = question.type === 'choice' && question.options 
                    ? (typeof question.options === 'string' ? JSON.parse(question.options || '[]') : question.options)
                    : [];
            }

            function toggleEditQuestionInputs() {
                const type = document.getElementById('edit-question-type').value;
                const optionsContainer = document.getElementById('edit-options-container');
                const rubricContainer = document.getElementById('edit-rubric-container');
                
                if (type === 'choice') {
                    optionsContainer.classList.remove('hidden');
                    rubricContainer.classList.add('hidden');
                } else if (type === 'essay') {
                    optionsContainer.classList.add('hidden');
                    rubricContainer.classList.remove('hidden');
                } else {
                    optionsContainer.classList.add('hidden');
                    rubricContainer.classList.add('hidden');
                }
            }

            function addEditOption() {
                const container = document.getElementById('edit-options-list');
                const index = container.children.length;
                const div = document.createElement('div');
                div.className = 'flex gap-2 mb-2';
                div.innerHTML = `
                    <input type="text" class="flex-1" id="edit-option-${index}" placeholder="ì„ íƒì§€ ì…ë ¥">
                    <button onclick="removeEditOption(${index})" class="btn btn-danger text-xs">ì‚­ì œ</button>
                `;
                container.appendChild(div);
            }

            function removeEditOption(index) {
                const input = document.getElementById(`edit-option-${index}`);
                if (input) {
                    input.parentElement.remove();
                }
            }

            async function saveEditedQuestion(questionId) {
                const group = document.getElementById('edit-question-group').value || 'ê¸°ë³¸ ê·¸ë£¹';
                const type = document.getElementById('edit-question-type').value;
                const points = parseFloat(document.getElementById('edit-question-points').value);
                const content = document.getElementById('edit-question-content').value;
                const answer = document.getElementById('edit-question-answer').value;
                const explanation = document.getElementById('edit-question-explanation').value;

                if (!content || !points || !answer) {
                    alert("ë¬¸ì œ ë‚´ìš©, ë°°ì , ì •ë‹µì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
                    return;
                }

                // ì„ íƒì§€ ìˆ˜ì§‘
                let options = "";
                if (type === 'choice') {
                    const optionInputs = document.querySelectorAll('#edit-options-list input[type="text"]');
                    const optionValues = Array.from(optionInputs).map(input => input.value).filter(v => v.trim());
                    if (optionValues.length === 0) {
                        alert("ì„ íƒí˜• ë¬¸ì œëŠ” ìµœì†Œ 1ê°œ ì´ìƒì˜ ì„ íƒì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
                        return;
                    }
                    options = JSON.stringify(optionValues);
                }

                // ì±„ì  ê¸°ì¤€ ìˆ˜ì§‘
                let rubric = "";
                if (type === 'essay') {
                    const r5 = document.getElementById('edit-rubric-5').value;
                    const r4 = document.getElementById('edit-rubric-4').value;
                    const r3 = document.getElementById('edit-rubric-3').value;
                    const r2 = document.getElementById('edit-rubric-2').value;
                    const r1 = document.getElementById('edit-rubric-1').value;
                    const p5 = document.getElementById('edit-rubric-points-5').value || '';
                    const p4 = document.getElementById('edit-rubric-points-4').value || '';
                    const p3 = document.getElementById('edit-rubric-points-3').value || '';
                    const p2 = document.getElementById('edit-rubric-points-2').value || '';
                    const p1 = document.getElementById('edit-rubric-points-1').value || '';
                    
                    if (!p5 || !p4 || !p3 || !p2 || !p1) {
                        alert("ì„œìˆ í˜• ì±„ì  ê¸°ì¤€ì˜ ëª¨ë“  ë°°ì ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        return;
                    }
                    
                    rubric = JSON.stringify({
                        5: { points: p5, criteria: r5 },
                        4: { points: p4, criteria: r4 },
                        3: { points: p3, criteria: r3 },
                        2: { points: p2, criteria: r2 },
                        1: { points: p1, criteria: r1 }
                    });
                }

                try {
                    const response = await fetch(APPS_CRIPT_URL + '?type=updateQuiz', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            id: questionId,
                            group,
                            type: getQuestionTypeName(type), // í•œê¸€ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥
                            points,
                            content,
                            answer,
                            options,
                            rubric,
                            explanation,
                            spreadsheetId: spreadsheetId
                        })
                    });

                    const result = await response.json();
                    
                    if (result.result === 'success') {
                        alert("ë¬¸ì œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        closeEditModal();
                        await loadDashboardData();
                    } else {
                        throw new Error(result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                    }
                } catch (err) {
                    console.error("Error updating question", err);
                    alert("ë¬¸ì œ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
                }
            }

            function closeEditModal() {
                const panel = document.getElementById('edit-question-panel');
                const overlay = document.getElementById('edit-question-overlay');
                if (panel) {
                    panel.classList.remove('active');
                    setTimeout(() => panel.remove(), 300);
                }
                if (overlay) {
                    overlay.classList.remove('active');
                    setTimeout(() => overlay.remove(), 300);
                }
            }

            // í•™ìƒ ì‘ë‹µ í…Œì´ë¸” í‘œì‹œ í•¨ìˆ˜
            function showAnswersTable(questionId, sortBy = null, sortOrder = 'asc') {
                const question = allQuestions.find(q => String(q.id) === String(questionId));
                if (!question) {
                    alert("ë¬¸ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                // qId íƒ€ì… ì¼ì¹˜ë¥¼ ìœ„í•´ Stringìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ
                let qAnswers = allAnswers.filter(a => String(a.qId) === String(questionId));
                
                // ì •ë ¬ ì ìš©
                if (sortBy === 'name') {
                    qAnswers.sort((a, b) => {
                        const nameA = (a.name || '').toLowerCase();
                        const nameB = (b.name || '').toLowerCase();
                        if (sortOrder === 'asc') {
                            return nameA.localeCompare(nameB);
                        } else {
                            return nameB.localeCompare(nameA);
                        }
                    });
                } else if (sortBy === 'sid') {
                    qAnswers.sort((a, b) => {
                        const sidA = (a.sid || '').toString();
                        const sidB = (b.sid || '').toString();
                        if (sortOrder === 'asc') {
                            return sidA.localeCompare(sidB, undefined, { numeric: true, sensitivity: 'base' });
                        } else {
                            return sidB.localeCompare(sidA, undefined, { numeric: true, sensitivity: 'base' });
                        }
                    });
                }
                
                // ì •ë ¬ ìƒíƒœ ì €ì¥ (ë‹¤ìŒ ì •ë ¬ì„ ìœ„í•´)
                if (!window.answersTableSortState) {
                    window.answersTableSortState = {};
                }
                window.answersTableSortState[questionId] = { sortBy, sortOrder };
                
                // ê¸°ì¡´ íŒ¨ë„ì´ ìˆìœ¼ë©´ ì œê±°
                const existingPanel = document.getElementById('answers-table-panel');
                if (existingPanel) {
                    existingPanel.remove();
                }
                const existingOverlay = document.getElementById('answers-table-overlay');
                if (existingOverlay) {
                    existingOverlay.remove();
                }

                // ìš°ì¸¡ ìŠ¬ë¼ì´ë”© íŒ¨ë„ ìƒì„±
                const overlay = document.createElement('div');
                overlay.className = 'slide-panel-overlay';
                overlay.id = 'answers-table-overlay';
                overlay.onclick = closeAnswersTable;
                
                const panel = document.createElement('div');
                panel.className = 'slide-panel';
                panel.id = 'answers-table-panel';

                // ì •ë ¬ ì•„ì´ì½˜ ìƒì„± í•¨ìˆ˜
                const getSortIcon = (column) => {
                    if (sortBy === column) {
                        return sortOrder === 'asc' ? ' â†‘' : ' â†“';
                    }
                    return ' â‡…';
                };

                // í…Œì´ë¸” í—¤ë” ìƒì„±
                let tableRows = '';
                if (qAnswers.length === 0) {
                    tableRows = '<tr><td colspan="6" class="text-center text-gray py-8">ì œì¶œëœ ë‹µì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                } else {
                    qAnswers.forEach((a, index) => {
                        const scoreData = allScores.find(s => s.sid === a.sid && String(s.qId) === String(questionId));
                        const isGraded = !!scoreData;
                        const score = isGraded ? scoreData.score : 0;
                        const feedback = isGraded ? scoreData.feedback : '';
                        
                        tableRows += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${a.name || ''}</td>
                                <td>${a.sid || ''}</td>
                                <td class="answer-cell">${(a.answer || '').substring(0, 100)}${(a.answer || '').length > 100 ? '...' : ''}</td>
                                <td>
                                    <span class="${isGraded ? 'text-success' : 'text-gray'}">
                                        ${isGraded ? score + 'ì  / ' + question.points + 'ì ' : 'ë¯¸ì±„ì '}
                                    </span>
                                </td>
                                <td>
                                    <button onclick="openAnswerDetail('${a.sid}', '${questionId}', '${(a.name || '').replace(/'/g, "\\'")}', '${(a.email || '').replace(/'/g, "\\'")}', '${(a.answer || '').replace(/'/g, "\\'").replace(/\n/g, '\\n')}', '${(question.content || '').replace(/'/g, "\\'")}', ${question.points}, ${score}, '${(feedback || '').replace(/'/g, "\\'").replace(/\n/g, '\\n')}', '${a.timestamp}')" 
                                            class="btn btn-primary text-xs px-3 py-1">í”¼ë“œë°±</button>
                                </td>
                            </tr>
                        `;
                    });
                }

                // ë‹¤ìŒ ì •ë ¬ ìˆœì„œ ê²°ì •
                const getNextSortOrder = (column) => {
                    if (sortBy === column) {
                        return sortOrder === 'asc' ? 'desc' : 'asc';
                    }
                    return 'asc';
                };

                panel.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold">í•™ìƒ ì‘ë‹µ ëª©ë¡</h3>
                        <button onclick="closeAnswersTable()" class="btn btn-secondary text-sm">âœ• ë‹«ê¸°</button>
                    </div>
                    <div class="mb-4">
                        <p class="text-sm text-gray mb-2">ë¬¸ì œ: ${question.content}</p>
                        <p class="text-xs text-gray">ì´ ${qAnswers.length}ê°œ ì‘ë‹µ</p>
                    </div>
                    <table class="answers-table">
                        <thead>
                            <tr>
                                <th>ë²ˆí˜¸</th>
                                <th>
                                    <button onclick="showAnswersTable('${questionId}', 'name', '${getNextSortOrder('name')}')" 
                                            class="text-left hover:text-primary transition cursor-pointer flex items-center gap-1">
                                        ì´ë¦„${getSortIcon('name')}
                                    </button>
                                </th>
                                <th>
                                    <button onclick="showAnswersTable('${questionId}', 'sid', '${getNextSortOrder('sid')}')" 
                                            class="text-left hover:text-primary transition cursor-pointer flex items-center gap-1">
                                        í•™ë²ˆ${getSortIcon('sid')}
                                    </button>
                                </th>
                                <th>ë‹µì•ˆ</th>
                                <th>ì ìˆ˜</th>
                                <th>ì‘ì—…</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                `;
                document.body.appendChild(overlay);
                document.body.appendChild(panel);
                
                // ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—° í›„ active í´ë˜ìŠ¤ ì¶”ê°€
                setTimeout(() => {
                    overlay.classList.add('active');
                    panel.classList.add('active');
                }, 10);
            }

            function closeAnswersTable() {
                const panel = document.getElementById('answers-table-panel');
                const overlay = document.getElementById('answers-table-overlay');
                if (panel) {
                    panel.classList.remove('active');
                    setTimeout(() => panel.remove(), 300);
                }
                if (overlay) {
                    overlay.classList.remove('active');
                    setTimeout(() => overlay.remove(), 300);
                }
            }

            // ê°œë³„ ì‘ë‹µ ìƒì„¸ ë³´ê¸° ë° í”¼ë“œë°± ì‘ì„±
            function openAnswerDetail(sid, qId, name, email, answer, questionContent, points, score, feedback, timestamp) {
                // ê¸°ì¡´ íŒ¨ë„ì´ ìˆìœ¼ë©´ ì œê±°
                const existingPanel = document.getElementById('answer-detail-panel');
                if (existingPanel) {
                    existingPanel.remove();
                }
                const existingOverlay = document.getElementById('answer-detail-overlay');
                if (existingOverlay) {
                    existingOverlay.remove();
                }

                // ìš°ì¸¡ ìŠ¬ë¼ì´ë”© íŒ¨ë„ ìƒì„±
                const overlay = document.createElement('div');
                overlay.className = 'slide-panel-overlay';
                overlay.id = 'answer-detail-overlay';
                overlay.onclick = closeAnswerDetail;
                
                const panel = document.createElement('div');
                panel.className = 'slide-panel';
                panel.id = 'answer-detail-panel';

                panel.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold">í”¼ë“œë°± ì‘ì„±</h3>
                        <button onclick="closeAnswerDetail()" class="btn btn-secondary text-sm">âœ• ë‹«ê¸°</button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm text-gray block mb-2">í•™ìƒ ì •ë³´</label>
                            <p class="text-white">${name} (${sid})</p>
                        </div>
                        <div>
                            <label class="text-sm text-gray block mb-2">ë¬¸ì œ</label>
                            <p class="text-white bg-white/5 p-3 rounded">${questionContent}</p>
                        </div>
                        <div>
                            <label class="text-sm text-gray block mb-2">í•™ìƒ ë‹µì•ˆ</label>
                            <div class="bg-white/5 p-4 rounded min-h-[150px] whitespace-pre-wrap">${answer}</div>
                        </div>
                        <div>
                            <label class="text-sm text-gray block mb-2">í˜„ì¬ ì ìˆ˜</label>
                            <p class="text-white">${score || 0}ì  / ${points}ì </p>
                        </div>
                        <div>
                            <label class="text-sm text-gray block mb-2">í”¼ë“œë°± ì‘ì„±</label>
                            <textarea id="answer-feedback-text" rows="6" class="w-full p-3 rounded bg-white/5" placeholder="í”¼ë“œë°±ì„ ì…ë ¥í•˜ì„¸ìš”">${feedback || ''}</textarea>
                        </div>
                        <div class="flex gap-4 mt-6">
                            <button onclick="saveAnswerFeedback('${sid}', '${qId}', '${email.replace(/'/g, "\\'")}', '${name.replace(/'/g, "\\'")}', '${questionContent.replace(/'/g, "\\'")}', ${points}, '${timestamp}')" 
                                    class="btn btn-primary flex-1">ì €ì¥ ë° ì´ë©”ì¼ ì „ì†¡</button>
                            <button onclick="closeAnswerDetail()" class="btn btn-secondary flex-1">ì·¨ì†Œ</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
                document.body.appendChild(panel);
                
                // ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—° í›„ active í´ë˜ìŠ¤ ì¶”ê°€
                setTimeout(() => {
                    overlay.classList.add('active');
                    panel.classList.add('active');
                }, 10);
            }

            function closeAnswerDetail() {
                const panel = document.getElementById('answer-detail-panel');
                const overlay = document.getElementById('answer-detail-overlay');
                if (panel) {
                    panel.classList.remove('active');
                    setTimeout(() => panel.remove(), 300);
                }
                if (overlay) {
                    overlay.classList.remove('active');
                    setTimeout(() => overlay.remove(), 300);
                }
            }

            async function saveAnswerFeedback(sid, qId, email, name, questionContent, points, timestamp) {
                const feedback = document.getElementById('answer-feedback-text').value;
                const scoreData = allScores.find(s => s.sid === sid && String(s.qId) === String(qId));
                const currentScore = scoreData ? scoreData.score : 0;

                await saveFeedbackAndSend(sid, qId, email, name, questionContent, currentScore, timestamp, feedback);
                closeAnswerDetail();
                // ì‘ë‹µ í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨ (ì •ë ¬ ìƒíƒœ ìœ ì§€)
                const questionId = qId;
                const sortState = window.answersTableSortState && window.answersTableSortState[questionId];
                closeAnswersTable();
                setTimeout(() => {
                    if (sortState) {
                        showAnswersTable(questionId, sortState.sortBy, sortState.sortOrder);
                    } else {
                        showAnswersTable(questionId);
                    }
                }, 350);
            }

            // ë¬¸ì œ ì‚­ì œ í•¨ìˆ˜
            async function deleteQuestion(questionId, questionContent) {
                if (!confirm(`ë‹¤ìŒ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${questionContent.substring(0, 50)}${questionContent.length > 50 ? '...' : ''}\n\nâš ï¸ ì£¼ì˜: ì´ ë¬¸ì œì™€ ê´€ë ¨ëœ ëª¨ë“  ë°ì´í„°(í•™ìƒ ì‘ë‹µ, ì ìˆ˜)ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                    return;
                }

                try {
                    const response = await fetch(APPS_CRIPT_URL + '?type=deleteQuiz', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            id: questionId,
                            spreadsheetId: spreadsheetId
                        })
                    });

                    // ì‘ë‹µì´ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
                    if (!response || !response.ok) {
                        throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${response ? response.status : 'No response'})`);
                    }

                    // ì‘ë‹µ ë³¸ë¬¸ í™•ì¸
                    const responseText = await response.text();
                    if (!responseText) {
                        throw new Error('ì„œë²„ì—ì„œ ë¹ˆ ì‘ë‹µì„ ë°›ì•˜ìŠµë‹ˆë‹¤.');
                    }

                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (parseErr) {
                        console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', parseErr);
                        console.error('ì‘ë‹µ í…ìŠ¤íŠ¸:', responseText);
                        throw new Error('ì„œë²„ ì‘ë‹µì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + responseText.substring(0, 100));
                    }
                    
                    if (result.result === 'success') {
                        alert("ë¬¸ì œì™€ ê´€ë ¨ëœ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\n(ë¬¸ì œ, í•™ìƒ ì‘ë‹µ, ì ìˆ˜)");
                        await loadDashboardData();
                    } else {
                        throw new Error(result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                    }
                } catch (err) {
                    console.error("Error deleting question", err);
                    alert("ë¬¸ì œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message + "\n\në„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                }
            }

            // ... grading logic ...
            async function runAutoGrading() {
                if (allQuestions.length === 0 || allAnswers.length === 0) {
                    alert("ì±„ì í•  ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
                    return;
                }

                const newScores = [];
                const timestamp = new Date().toISOString();

                alert("ì±„ì ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...");

                // ê¸°ì¡´ ì ìˆ˜ í™•ì¸ (ì¤‘ë³µ ì €ì¥ ë°©ì§€)
                const scoreRes = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: spreadsheetId,
                    range: 'SCORE!A2:H'
                });

                const existingScores = scoreRes.result.values ? scoreRes.result.values.map(r => ({
                    sid: String(r[1]), qId: String(r[3])
                })) : [];

                for (const a of allAnswers) {
                    // Check if already graded (íƒ€ì… ì¼ì¹˜ë¥¼ ìœ„í•´ Stringìœ¼ë¡œ ë³€í™˜)
                    const alreadyGraded = existingScores.find(s => 
                        s.sid === String(a.sid) && s.qId === String(a.qId)
                    );
                    if (alreadyGraded) {
                        console.log(`Score already exists for ${a.sid}, Q${a.qId}, skipping...`);
                        continue;
                    }

                    // allScoresì—ì„œë„ í™•ì¸ (ë©”ëª¨ë¦¬ ìºì‹œ)
                    if (allScores.find(s => String(s.sid) === String(a.sid) && String(s.qId) === String(a.qId))) {
                        continue;
                    }

                    const q = allQuestions.find(q => String(q.id) === String(a.qId));
                    if (!q) continue;

                    let score = 0;
                    let feedback = "";

                    if (q.type === 'essay') {
                        // Call Netlify Function
                        try {
                            const res = await fetch('/.netlify/functions/grade', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    question: q.content,
                                    studentAnswer: a.answer,
                                    rubric: q.rubric,
                                    correctAnswer: q.answer,
                                    type: 'essay'
                                })
                            });

                            // ì‘ë‹µ í…ìŠ¤íŠ¸ ë¨¼ì € ê°€ì ¸ì˜¤ê¸°
                            const responseText = await res.text();
                            
                            // ì‘ë‹µ ìƒíƒœ í™•ì¸
                            if (!res.ok) {
                                console.error('AI Grading API Error:', res.status, responseText);
                                
                                // JSON í˜•ì‹ì˜ ì—ëŸ¬ ì‘ë‹µì¸ì§€ í™•ì¸
                                let errorData;
                                try {
                                    errorData = JSON.parse(responseText);
                                    if (errorData.error && errorData.score !== undefined) {
                                        score = errorData.score || 0;
                                        feedback = errorData.feedback || errorData.error || 'ì±„ì  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                                        continue; // ë‹¤ìŒ ë‹µì•ˆìœ¼ë¡œ
                                    }
                                } catch (parseErr) {
                                    // JSONì´ ì•„ë‹Œ ê²½ìš°
                                }
                                
                                throw new Error(`ì±„ì  API ì˜¤ë¥˜ (${res.status})`);
                            }

                            // JSON íŒŒì‹± ì‹œë„
                            let data;
                            try {
                                data = JSON.parse(responseText);
                            } catch (parseError) {
                                console.error('Failed to parse JSON response:', parseError);
                                console.error('Response text:', responseText.substring(0, 500));
                                throw new Error('ì±„ì  ì„œë²„ ì‘ë‹µì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            }
                            
                            // ì—ëŸ¬ í•„ë“œê°€ ìˆì§€ë§Œ scoreì™€ feedbackë„ ìˆëŠ” ê²½ìš° ì²˜ë¦¬
                            if (data.error && data.score === undefined) {
                                throw new Error(data.error || 'ì±„ì  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                            }
                            score = typeof data.score === 'number' ? data.score : 0;
                            feedback = typeof data.feedback === 'string' ? data.feedback : 'ì±„ì  ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                        } catch (e) {
                            console.error('AI Grading Error', e);
                            score = 0;
                            feedback = "AI ì±„ì  ì‹¤íŒ¨: " + (e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                        }
                    } else if (q.type === 'choice') {
                        // ì„ íƒí˜• ì±„ì  - ë²ˆí˜¸, ë‚´ìš©, ì„ íƒì§€ ì¸ë±ìŠ¤ ëª¨ë‘ ì§€ì›
                        const studentAns = a.answer.trim();
                        const correctAns = q.answer.trim();
                        const options = q.options ? (typeof q.options === 'string' ? JSON.parse(q.options) : q.options) : [];

                        // 1. ì§ì ‘ ë‚´ìš© ë¹„êµ
                        if (studentAns === correctAns) {
                            score = q.points;
                            feedback = "ì •ë‹µì…ë‹ˆë‹¤.";
                        } else {
                            // 2. ì„ íƒì§€ ì¸ë±ìŠ¤ë¡œ ë¹„êµ
                            const studentIndex = options.findIndex(opt => opt === studentAns);
                            const correctIndex = options.findIndex(opt => opt === correctAns);

                            if (studentIndex !== -1 && correctIndex !== -1 && studentIndex === correctIndex) {
                                score = q.points;
                                feedback = "ì •ë‹µì…ë‹ˆë‹¤.";
                            } else {
                                // 3. ë²ˆí˜¸ë¡œ ë¹„êµ (ì •ë‹µì´ "1", "2" ê°™ì€ ê²½ìš°)
                                const numPattern = /^(\d+)$/;
                                if (numPattern.test(correctAns)) {
                                    const correctNum = parseInt(correctAns);
                                    if (studentIndex === correctNum - 1) {
                                        score = q.points;
                                        feedback = "ì •ë‹µì…ë‹ˆë‹¤.";
                                    } else {
                                        score = 0;
                                        feedback = `ì˜¤ë‹µì…ë‹ˆë‹¤. (ì •ë‹µ: ${correctAns}) ${q.explanation || ''}`;
                                    }
                                } else {
                                    score = 0;
                                    feedback = `ì˜¤ë‹µì…ë‹ˆë‹¤. (ì •ë‹µ: ${correctAns}) ${q.explanation || ''}`;
                                }
                            }
                        }
                    } else {
                        // ë‹¨ë‹µí˜• Simple Match Logic
                        if (a.answer.trim() === q.answer.trim()) {
                            score = q.points;
                            feedback = "ì •ë‹µì…ë‹ˆë‹¤.";
                        } else {
                            score = 0;
                            feedback = `ì˜¤ë‹µì…ë‹ˆë‹¤. (ì •ë‹µ: ${q.answer}) ${q.explanation || ''}`;
                        }
                    }

                    // ìœ í˜•ì„ í•œê¸€ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥
                    const typeKorean = getQuestionTypeName(q.type);
                    
                    newScores.push([
                        timestamp,
                        a.sid,
                        a.name,
                        q.id,
                        score,
                        feedback,
                        typeKorean,
                        '' // EmailStatus - ì´ˆê¸°ê°’ì€ ë¹ˆ ë¬¸ìì—´
                    ]);
                }

                if (newScores.length > 0) {
                    try {
                        // ì €ì¥ ì „ì— ë‹¤ì‹œ í•œë²ˆ ì¤‘ë³µ í™•ì¸ (ì‹¤ì œ DBì—ì„œ í™•ì¸)
                        const finalScoreRes = await gapi.client.sheets.spreadsheets.values.get({
                            spreadsheetId: spreadsheetId,
                            range: 'SCORE!A2:H'
                        });

                        const finalExistingScores = finalScoreRes.result.values ? finalScoreRes.result.values.map(r => ({
                            sid: String(r[1]), qId: String(r[3])
                        })) : [];

                        // ì¤‘ë³µ ì œê±°: ì´ë¯¸ ì €ì¥ëœ ì ìˆ˜ëŠ” ì œì™¸
                        const uniqueNewScores = newScores.filter(scoreRow => {
                            const sid = String(scoreRow[1]);
                            const qId = String(scoreRow[3]);
                            return !finalExistingScores.find(s => s.sid === sid && s.qId === qId);
                        });

                        if (uniqueNewScores.length === 0) {
                            alert("ìƒˆë¡œ ì±„ì í•  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. (ì´ë¯¸ ì €ì¥ëœ ì ìˆ˜ê°€ ìˆìŠµë‹ˆë‹¤)");
                            await loadDashboardData();
                            return;
                        }

                        await checkAndWriteHeader('SCORE', ["Timestamp", "StudentID", "Name", "Q_ID", "Score", "Feedback", "Type", "EmailStatus"]);

                        await gapi.client.sheets.spreadsheets.values.append({
                            spreadsheetId: spreadsheetId,
                            range: 'SCORE!A2',
                            valueInputOption: 'RAW',
                            resource: {
                                values: uniqueNewScores
                            }
                        });

                        alert(`${uniqueNewScores.length}ê±´ì˜ ì±„ì ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        await loadDashboardData(); // Reload
                    } catch (err) {
                        console.error("Save Scores Error", err);
                        alert("ì ìˆ˜ ì €ì¥ ì‹¤íŒ¨");
                    }
                } else {
                    alert("ìƒˆë¡œ ì±„ì í•  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
                }
            }

            async function saveFeedbackAndSend(sid, qId, email, name, question, score, timestamp, feedbackParam = null) {
                let feedback;
                if (feedbackParam !== null) {
                    feedback = feedbackParam.trim();
                } else {
                    const feedbackTextarea = document.getElementById(`fb_${sid}_${qId}`);
                    feedback = feedbackTextarea ? feedbackTextarea.value.trim() : '';
                }

                if (!feedback) {
                    alert("í”¼ë“œë°±ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                try {
                    // 1. SCORE ì‹œíŠ¸ì—ì„œ í•´ë‹¹ í–‰ ì°¾ê¸° ë° ì—…ë°ì´íŠ¸
                    const scoreRes = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: spreadsheetId,
                        range: 'SCORE!A2:H'
                    });

                    if (!scoreRes.result.values) {
                        alert("ì±„ì  ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }

                    // í•´ë‹¹ í•™ìƒê³¼ ë¬¸ì œì˜ í–‰ ì°¾ê¸° (íƒ€ì… ì¼ì¹˜ë¥¼ ìœ„í•´ Stringìœ¼ë¡œ ë³€í™˜)
                    let rowIndex = -1;
                    for (let i = 0; i < scoreRes.result.values.length; i++) {
                        const row = scoreRes.result.values[i];
                        if (String(row[1]) === String(sid) && String(row[3]) === String(qId)) {
                            rowIndex = i + 2; // +2 because range starts at A2
                            break;
                        }
                    }

                    if (rowIndex === -1) {
                        alert("ì±„ì  ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € AI ì±„ì ì´ ì™„ë£Œë˜ì–´ì•¼ í•©ë‹ˆë‹¤.");
                        return;
                    }

                    // í”¼ë“œë°± ì—´(Fì—´, ì¸ë±ìŠ¤ 5) ì—…ë°ì´íŠ¸
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: spreadsheetId,
                        range: `SCORE!F${rowIndex}`,
                        valueInputOption: 'RAW',
                        resource: {
                            values: [[feedback]]
                        }
                    });

                    // 2. ì´ë©”ì¼ ì „ì†¡ ë° ìƒíƒœ ì €ì¥
                    let emailStatus = '';
                    if (email) {
                        if (!confirm(`${name} í•™ìƒì—ê²Œ ì±„ì  ê²°ê³¼ë¥¼ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                            alert("í”¼ë“œë°±ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                            await loadDashboardData(); // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                            return;
                        }

                        // Gmail API ì´ˆê¸°í™” í™•ì¸
                        if (!gapi.client.gmail) {
                            try {
                                await gapi.client.load('gmail', 'v1');
                            } catch (loadErr) {
                                console.error("Gmail API load error", loadErr);
                                emailStatus = 'fail';
                                // ì´ë©”ì¼ ìƒíƒœ ì €ì¥
                                await gapi.client.sheets.spreadsheets.values.update({
                                    spreadsheetId: spreadsheetId,
                                    range: `SCORE!H${rowIndex}`,
                                    valueInputOption: 'RAW',
                                    resource: {
                                        values: [[emailStatus]]
                                    }
                                });
                                alert("í”¼ë“œë°±ì€ ì €ì¥ë˜ì—ˆì§€ë§Œ Gmail APIë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                                await loadDashboardData();
                                return;
                            }
                        }

                        const subject = `[ì±„ì  ê²°ê³¼] ${question.substring(0, 30)}... ë¬¸í•­ì— ëŒ€í•œ ì±„ì  ê²°ê³¼ì…ë‹ˆë‹¤.`;
                        const body = `
ì•ˆë…•í•˜ì„¸ìš”, ${name} í•™ìƒ.

ì œì¶œí•˜ì‹  ë¬¸í•­ì— ëŒ€í•œ ì±„ì  ê²°ê³¼ì…ë‹ˆë‹¤.

[ë¬¸í•­]: ${question}
[ì ìˆ˜]: ${score}ì 
[ì„ ìƒë‹˜ í”¼ë“œë°±]:
${feedback}

ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.
            `;

                        const utf8Subject = `=?utf-8?B?${btoa(unescape(encodeURIComponent(subject)))}?=`;
                        const messageParts = [
                            `To: ${email}`,
                            `Subject: ${utf8Subject}`,
                            "Content-Type: text/plain; charset=utf-8",
                            "MIME-Version: 1.0",
                            "",
                            body
                        ];
                        const message = messageParts.join('\n');
                        const encodedMessage = btoa(unescape(encodeURIComponent(message)))
                            .replace(/\+/g, '-')
                            .replace(/\//g, '_')
                            .replace(/=+$/, '');

                        try {
                            await gapi.client.gmail.users.messages.send({
                                'userId': 'me',
                                'resource': {
                                    'raw': encodedMessage
                                }
                            });
                            emailStatus = 'success';
                            alert("í”¼ë“œë°±ì´ ì €ì¥ë˜ê³  ì´ë©”ì¼ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        } catch (err) {
                            console.error("Email Send Error", err);
                            emailStatus = 'fail';
                            const errorMsg = err.result?.error?.message || err.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";
                            alert("í”¼ë“œë°±ì€ ì €ì¥ë˜ì—ˆì§€ë§Œ ì´ë©”ì¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + errorMsg);
                        }

                        // ì´ë©”ì¼ ì „ì†¡ ìƒíƒœ ì €ì¥ (Hì—´, ì¸ë±ìŠ¤ 7)
                        await gapi.client.sheets.spreadsheets.values.update({
                            spreadsheetId: spreadsheetId,
                            range: `SCORE!H${rowIndex}`,
                            valueInputOption: 'RAW',
                            resource: {
                                values: [[emailStatus]]
                            }
                        });
                    } else {
                        alert("í”¼ë“œë°±ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }

                    // 3. ëŒ€ì‹œë³´ë“œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                    await loadDashboardData();

                } catch (err) {
                    console.error("Save Feedback Error", err);
                    alert("í”¼ë“œë°± ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
                }
            }

            function switchTab(tabName) {
                try {
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

                    document.getElementById('tab-quiz-setup').classList.add('hidden');
                    document.getElementById('tab-results').classList.add('hidden');

                    const target = document.getElementById(`tab-${tabName}`);
                    if (target) {
                        target.classList.remove('hidden');
                        target.classList.add('fade-in'); // Re-trigger animation
                    }

                    // Highlight sidebar
                    if (tabName === 'quiz-setup') document.querySelectorAll('.nav-item')[0].classList.add('active');
                    if (tabName === 'results') {
                        document.querySelectorAll('.nav-item')[1].classList.add('active');
                        loadDashboardData(); // Refresh data
                    }
                } catch (e) {
                    console.error("Tab Switch Error", e);
                    alert("íƒ­ ì „í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
                }
            }

            function openSpreadsheet() {
                if (!spreadsheetId) {
                    alert("ì—°ë™ëœ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.");
                    return;
                }
                window.open('https://docs.google.com/spreadsheets/d/' + spreadsheetId, '_blank');
            }

            function copyFolderLink(link, groupName) {
                navigator.clipboard.writeText(link).then(() => {
                    alert(`"${groupName}" í´ë” ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n${link}`);
                }).catch(err => {
                    console.error('ë§í¬ ë³µì‚¬ ì‹¤íŒ¨:', err);
                    alert('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”:\n' + link);
                });
            }


            // Theme Selector Logic
            function setTheme(theme) {
                document.body.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            }

            // Initial Theme Load
            const savedTheme = localStorage.getItem('theme') || 'dark';
            setTheme(savedTheme);

            // UI Helpers for Quiz Setup
            function toggleQuestionInputs() {
                const type = document.getElementById('question-type').value;

                // Toggle Options
                if (type === 'choice') {
                    document.getElementById('options-container').classList.remove('hidden');
                } else {
                    document.getElementById('options-container').classList.add('hidden');
                }

                // Toggle Rubric
                if (type === 'essay') {
                    document.getElementById('rubric-container').classList.remove('hidden');
                } else {
                    document.getElementById('rubric-container').classList.add('hidden');
                }
            }

            let currentOptions = [];

            function addOption() {
                const list = document.getElementById('options-list');
                const idx = list.children.length + 1;
                const div = document.createElement('div');
                div.className = "flex items-center w-full";
                div.style.gap = "2rem"; // Increased gap explicitly
                div.innerHTML = `
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-purple-600 text-white font-bold text-sm shadow-lg flex-shrink-0">
                    ${idx}
                </div>
                <input type="text" class="option-input flex-1" placeholder="ì„ íƒì§€ ${idx} ë‚´ìš©" oninput="updateOptionsData()">
                <button onclick="this.parentElement.remove(); updateOptionsData();" class="btn btn-primary text-xs px-4 py-2 flex-shrink-0" style="min-width: auto;">
                    ì‚­ì œ
                </button>
            `;
                list.appendChild(div);
                updateOptionsData();
            }

            function updateOptionsData() {
                // Collect option texts
                const inputs = document.querySelectorAll('.option-input');
                currentOptions = Array.from(inputs).map(i => i.value);
            }

            // ... existing functions ...);

            async function addQuestion() {
                const type = document.getElementById('question-type').value;
                const points = document.getElementById('question-points').value;
                const content = document.getElementById('question-content').value;
                const answer = document.getElementById('question-answer').value;
                const group = document.getElementById('question-group').value || 'ê¸°ë³¸ ê·¸ë£¹';
                const explanation = document.getElementById('question-explanation').value;

                if (!content || !points || !answer) {
                    alert("ë¬¸ì œ ë‚´ìš©, ë°°ì , ì •ë‹µì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
                    return;
                }

                // Collect Rubric
                let rubric = "";
                if (type === 'essay') {
                    const r5 = document.getElementById('rubric-5').value;
                    const r4 = document.getElementById('rubric-4').value;
                    const r3 = document.getElementById('rubric-3').value;
                    const r2 = document.getElementById('rubric-2').value;
                    const r1 = document.getElementById('rubric-1').value;
                    const p5 = document.getElementById('rubric-points-5').value || '';
                    const p4 = document.getElementById('rubric-points-4').value || '';
                    const p3 = document.getElementById('rubric-points-3').value || '';
                    const p2 = document.getElementById('rubric-points-2').value || '';
                    const p1 = document.getElementById('rubric-points-1').value || '';
                    
                    // ì ìˆ˜ê°€ ì…ë ¥ë˜ì§€ ì•Šì€ ê²½ìš° ê²½ê³ 
                    if (!p5 || !p4 || !p3 || !p2 || !p1) {
                        alert("ì„œìˆ í˜• ì±„ì  ê¸°ì¤€ì˜ ëª¨ë“  ë°°ì ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        return;
                    }
                    rubric = JSON.stringify({
                        5: { points: p5, criteria: r5 },
                        4: { points: p4, criteria: r4 },
                        3: { points: p3, criteria: r3 },
                        2: { points: p2, criteria: r2 },
                        1: { points: p1, criteria: r1 }
                    });
                }

                // Collect Options
                let options = "";
                if (type === 'choice') {
                    options = JSON.stringify(currentOptions);
                }

                const question = {
                    id: Date.now(),
                    group,
                    type,
                    points,
                    content,
                    answer,
                    options,
                    rubric,
                    explanation
                };

                questions.push(question);
                renderQuestions();

                // Clear inputs (Partial clear)
                document.getElementById('question-content').value = '';
                document.getElementById('question-answer').value = '';
                // Don't clear group to allow continuous entry
                if (type === 'choice') {
                    document.getElementById('options-list').innerHTML = '';
                    currentOptions = [];
                }
                if (type === 'essay') {
                    for (let i = 1; i <= 5; i++) {
                        document.getElementById(`rubric-${i}`).value = '';
                        const pointsInput = document.getElementById(`rubric-points-${i}`);
                        if (pointsInput) pointsInput.value = '';
                    }
                }
                document.getElementById('question-explanation').value = '';
            }

            function renderQuestions() {
                const list = document.getElementById('questions-list');
                list.innerHTML = '';

                if (questions.length === 0) {
                    list.innerHTML = '<div class="p-4 border border-white/10 rounded mb-2">ì•„ì§ ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                questions.forEach((q, index) => {
                    const div = document.createElement('div');
                    div.className = 'p-4 border border-white/10 rounded mb-2 bg-white/5';
                    div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-bold">Q${index + 1}. [${q.group}] (${q.points}ì )</span>
                        <button onclick="removeQuestion(${index})" class="btn btn-primary text-xs px-4 py-2">
                            ğŸ—‘ï¸ ì‚­ì œ
                        </button>
                    </div>
                    <p class="text-sm mt-1">${q.content}</p>
                    <p class="text-xs text-secondary mt-1">ë‹µ: ${q.answer}</p>
                `;
                    list.appendChild(div);
                });
            }

            // ìœ í˜•ì„ í•œê¸€ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
            function getQuestionTypeName(type) {
                if (type === 'choice' || type === 'ì„ íƒí˜•') return 'ì„ íƒí˜•';
                if (type === 'short' || type === 'ë‹¨ë‹µí˜•') return 'ë‹¨ë‹µí˜•';
                if (type === 'essay' || type === 'ì„œë…¼ìˆ í˜•') return 'ì„œë…¼ìˆ í˜•';
                return type; // ì´ë¯¸ í•œê¸€ì´ê±°ë‚˜ ì•Œ ìˆ˜ ì—†ëŠ” ê²½ìš° ê·¸ëŒ€ë¡œ ë°˜í™˜
            }

            // ìœ í˜•ì„ ì˜ì–´ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜ (ë‚´ë¶€ ì²˜ë¦¬ìš©)
            function getQuestionTypeEnglish(type) {
                if (type === 'ì„ íƒí˜•' || type === 'choice') return 'choice';
                if (type === 'ë‹¨ë‹µí˜•' || type === 'short') return 'short';
                if (type === 'ì„œë…¼ìˆ í˜•' || type === 'essay') return 'essay';
                return type; // ì´ë¯¸ ì˜ì–´ì´ê±°ë‚˜ ì•Œ ìˆ˜ ì—†ëŠ” ê²½ìš° ê·¸ëŒ€ë¡œ ë°˜í™˜
            }

            function removeQuestion(index) {
                questions.splice(index, 1);
                renderQuestions();
            }

            async function saveToSheets() {
                if (questions.length === 0) {
                    alert("ì €ì¥í•  ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                try {
                    // ì•±ìŠ¤í¬ë¦½íŠ¸ë¥¼ í†µí•´ ì €ì¥ (ë¬¸ì œ ì €ì¥ìš© ì‹œíŠ¸ = ìŠ¤í”„ë ˆë“œ ì‹œíŠ¸ ì—´ê¸°ë¡œ ë“¤ì–´ê°€ëŠ” ì‹œíŠ¸ì— ì €ì¥)
                    const response = await fetch(getAppsScriptUrl() + '?type=quiz', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            questions: questions.map(q => ({
                                ...q,
                                type: getQuestionTypeName(q.type) // í•œê¸€ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥
                            })),
                            spreadsheetId: spreadsheetId
                        })
                    });

                    const result = await response.json();
                    
                    if (result.result === 'success') {
                        alert(`ë¬¸ì œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (${result.count || questions.length}ê°œ)\n\nê° í´ë”ë³„ ë§í¬ëŠ” 'ê²°ê³¼ ë° ì±„ì ' íƒ­ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                        
                        // ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë„ ìƒˆë¡œê³ ì¹¨ (ì„ íƒì‚¬í•­)
                        if (typeof loadDashboardData === 'function') {
                            await loadDashboardData();
                        }
                    } else {
                        throw new Error(result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                    }

                } catch (err) {
                    console.error("Error saving to sheets via App Script", err);
                    
                    // í´ë°±: ì§ì ‘ GAPIë¡œ ì €ì¥ ì‹œë„
                    try {
                        console.log("Falling back to direct GAPI save...");
                        const header = ["ID", "Group", "Type", "Points", "Question", "Answer", "Options", "Rubric", "Explanation"];
                        await checkAndWriteHeader('Quiz', header);

                        const values = questions.map(q => [
                            q.id,
                            q.group,
                            getQuestionTypeName(q.type), // í•œê¸€ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥
                            q.points,
                            q.content,
                            q.answer,
                            q.options || "",
                            q.rubric || "",
                            q.explanation || ""
                        ]);

                        await gapi.client.sheets.spreadsheets.values.append({
                            spreadsheetId: spreadsheetId,
                            range: 'Quiz!A2',
                            valueInputOption: 'RAW',
                            resource: {
                                values: values
                            }
                        });

                        alert("ë¬¸ì œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (GAPI ì§ì ‘ ì €ì¥)\n\nê° í´ë”ë³„ ë§í¬ëŠ” 'ê²°ê³¼ ë° ì±„ì ' íƒ­ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                    } catch (fallbackErr) {
                        console.error("Fallback save also failed", fallbackErr);
                        alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + (err.message || err.toString()) + "\n\ní´ë°± ì €ì¥ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + (fallbackErr.message || fallbackErr.toString()));
                    }
                }
            }

            async function checkAndWriteHeader(sheetName, headerRow) {
                try {
                    const res = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: spreadsheetId,
                        range: `${sheetName}!A1:A1`
                    });

                    if (!res.result.values || res.result.values.length === 0) {
                        await gapi.client.sheets.spreadsheets.values.update({
                            spreadsheetId: spreadsheetId,
                            range: `${sheetName}!A1`,
                            valueInputOption: 'RAW',
                            resource: {
                                values: [headerRow]
                            }
                        });
                    }
                } catch (err) {
                    console.error("Error checking headers", err);
                }
            }

            // ... (Header Functions) ...

            // Student Logic
            function checkForStudentLink() {
                const urlParams = new URLSearchParams(window.location.search);
                const quizId = urlParams.get('quiz');
                const groupFilter = urlParams.get('group');
                if (quizId) {
                    // í•™ìƒ ëª¨ë“œ í™œì„±í™” (í€´ì¦ˆ ì‹œíŠ¸ì™€ ë™ì¼í•œ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì˜ Apps Script URL ì‚¬ìš©)
                    spreadsheetId = quizId;
                    studentAppsScriptUrl = urlParams.get('appsScriptUrl') || APPS_CRIPT_URL;
                    localStorage.setItem('grading_spreadsheet_id', quizId);
                    if (groupFilter) {
                        localStorage.setItem('student_group_filter', decodeURIComponent(groupFilter));
                    }
                    
                    // ëª¨ë“  êµì‚¬ ê´€ë ¨ í™”ë©´ ìˆ¨ê¸°ê¸°
                    document.getElementById('login-view').classList.add('hidden');
                    document.getElementById('teacher-dashboard').classList.add('hidden');
                    document.getElementById('teacher-dashboard').classList.remove('flex');
                    
                    // í•™ìƒ ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
                    showStudentLogin();
                } else {
                    // í•™ìƒ ë§í¬ê°€ ì—†ìœ¼ë©´ ì¼ë°˜ ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ (êµì‚¬ ëª¨ë“œ)
                    // ë‹¨, ì´ë¯¸ ë¡œê·¸ì¸ëœ ìƒíƒœë©´ êµì‚¬ ëŒ€ì‹œë³´ë“œ ìœ ì§€
                    const existingToken = gapi.client.getToken();
                    if (!existingToken) {
                        document.getElementById('login-view').classList.remove('hidden');
                        document.getElementById('teacher-dashboard').classList.add('hidden');
                        document.getElementById('student-login-view').classList.add('hidden');
                        document.getElementById('student-quiz-view').classList.add('hidden');
                    }
                }
            }

            async function startStudentQuiz() {
                const sid = document.getElementById('student-id').value;
                const sname = document.getElementById('student-name').value;

                if (!sid || !sname) {
                    alert("í•™ë²ˆê³¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                // NOTE: Since user wants NO Google Login for students, we rely on API Key.
                // This requires the sheet to be readable by anyone with the link (or public).
                // Submitting answers will fail unless the sheet is writable by anyone with the link.

                // ëª¨ë“  êµì‚¬ ê´€ë ¨ í™”ë©´ ìˆ¨ê¸°ê¸°
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('teacher-dashboard').classList.add('hidden');
                document.getElementById('teacher-dashboard').classList.remove('flex');
                
                // í•™ìƒ í™”ë©´ë§Œ í‘œì‹œ
                document.getElementById('student-login-view').classList.add('hidden');
                document.getElementById('student-quiz-view').classList.remove('hidden');

                // Try initializing client with API Key if not already
                // If already init with ClientId (Teacher flow), it's fine.
                // If Student flow, we might need to init gapi.client if not done.
                if (!gapi.client.sheets) {
                    await new Promise(resolve => gapi.load('client', resolve));
                    await gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: [DISCOVERY_DOC],
                    });
                }

                await loadQuizFromSheets();
            }

            async function loadQuizFromSheets() {
                try {
                    let rows = [];

                    // 1. Try fetching from App Script (í´ë” ë§í¬ì˜ appsScriptUrl ì‚¬ìš© â†’ ê°™ì€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ ë¬¸ì œ ë¡œë“œ)
                    try {
                        const res = await fetch(getAppsScriptUrl() + '?type=quiz&spreadsheetId=' + encodeURIComponent(spreadsheetId));
                        const json = await res.json();

                        // Handle different possible return formats
                        if (json.data && Array.isArray(json.data)) rows = json.data;
                        else if (Array.isArray(json)) rows = json;
                        else if (json.values && Array.isArray(json.values)) rows = json.values;

                        console.log("Loaded via App Script", rows.length);
                    } catch (scriptErr) {
                        console.warn("App Script Load Failed, falling back to GAPI", scriptErr);

                        // 2. Fallback to GAPI (Requires Public Sheet or User Login)
                        const response = await gapi.client.sheets.spreadsheets.values.get({
                            spreadsheetId: spreadsheetId,
                            range: 'Quiz!A2:I',
                        });
                        rows = response.result.values;
                    }

                    if (!rows || rows.length === 0) {
                        document.getElementById('student-questions-container').innerHTML = 'ë¬¸ì œ ë¡œë“œ ì‹¤íŒ¨ ë˜ëŠ” ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.';
                        return;
                    }

                    // Parse rows: [ID, Group, Type, Points, Question, Answer, Options, Rubric, Explanation]
                    let loadedQuestions = rows.map(row => ({
                        id: row[0],
                        group: row[1] || 'ê¸°ë³¸ ê·¸ë£¹',
                        type: getQuestionTypeEnglish(row[2] || ''), // í•œê¸€/ì˜ì–´ ëª¨ë‘ ì²˜ë¦¬í•˜ì—¬ ì˜ì–´ë¡œ ì •ê·œí™” (ë‚´ë¶€ ì²˜ë¦¬ìš©)
                        points: row[3],
                        content: row[4],
                        answer: row[5],
                        options: row[6] ? (typeof row[6] === 'string' ? JSON.parse(row[6] || '[]') : row[6]) : [],
                        rubric: row[7] || '',
                        explanation: row[8] || ''
                    }));

                    // Filter by group if specified
                    const groupFilter = localStorage.getItem('student_group_filter');
                    if (groupFilter) {
                        loadedQuestions = loadedQuestions.filter(q => q.group === groupFilter);
                        if (loadedQuestions.length === 0) {
                            document.getElementById('student-questions-container').innerHTML =
                                `"${groupFilter}" ê·¸ë£¹ì— ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.`;
                            return;
                        }
                    }

                    renderStudentQuiz(loadedQuestions);
                } catch (err) {
                    console.error("Error loading quiz", err);
                    alert("ë¬¸ì œ ë¡œë“œ ì‹¤íŒ¨. (ìŠ¤í”„ë ˆë“œì‹œíŠ¸ê°€ 'ë§í¬ê°€ ìˆëŠ” ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ê³µê°œ' ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.)");
                }
            }

            // Store questions globally for grading
            let studentQuestions = [];

            function renderStudentQuiz(qs) {
                studentQuestions = qs; // Store for grading
                const container = document.getElementById('student-questions-container');
                container.innerHTML = '';

                qs.forEach((q, idx) => {
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.id = `question-${q.id}`;

                    let inputHtml = '';
                    if (q.type === 'choice') {
                        let optionsHtml = '<div class="flex flex-col gap-2 mt-2">';
                        q.options.forEach((opt, oIdx) => {
                            optionsHtml += `
                            <label class="flex items-center gap-3 cursor-pointer p-3 border border-white/10 rounded hover:bg-white/5 transition">
                                <input type="radio" name="q_${q.id}" value="${opt}">
                                <div class="flex items-center justify-center w-8 h-8 rounded-full bg-gradient-to-br from-purple-400 to-purple-600 text-white font-bold text-xs shadow-md">
                                    ${oIdx + 1}
                                </div>
                                <span class="flex-1">${opt}</span>
                            </label>
                         `;
                        });
                        optionsHtml += '</div>';
                        inputHtml = optionsHtml;
                    } else if (q.type === 'essay') {
                        inputHtml = `<textarea name="q_${q.id}" rows="5" class="w-full mt-2" placeholder="ë‹µì•ˆì„ ì‘ì„±í•˜ì„¸ìš”"></textarea>`;
                    } else {
                        inputHtml = `<input type="text" name="q_${q.id}" class="w-full mt-2" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”">`;
                    }

                    div.innerHTML = `
                    <h3 class="text-xl font-bold mb-4">Q${idx + 1}. (${q.points}ì ) <span class="text-sm text-gray">[${q.group || ''}]</span></h3>
                    <p class="mb-8 text-lg p-4 bg-white/5 rounded leading-relaxed">${q.content}</p>
                    <div class="mb-8">
                        ${inputHtml}
                    </div>
                    <div id="result-${q.id}" class="result-card hidden mt-6"></div>
                `;
                    container.appendChild(div);
                });
            }

            function toggleEmailInput() {
                const checked = document.getElementById('request-feedback').checked;
                if (checked) {
                    document.getElementById('email-input-section').classList.remove('hidden');
                } else {
                    document.getElementById('email-input-section').classList.add('hidden');
                }
            }

            function showLoadingAnimation(qId) {
                const resultDiv = document.getElementById(`result-${qId}`);
                if (!resultDiv) return;

                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = `
                    <div class="loading-container">
                        <div class="loading-donut"></div>
                        <p class="text-lg font-bold animate-pulse">AI ì±„ì  ì§„í–‰ ì¤‘...</p>
                    </div>
                `;
            }

            function showGradingResult(qId, question, studentAnswer, score, feedback, isCorrect) {
                const resultDiv = document.getElementById(`result-${qId}`);
                if (!resultDiv) return;

                resultDiv.classList.remove('hidden');
                resultDiv.className = `result-card ${isCorrect ? 'result-correct' : 'result-incorrect'}`;
                resultDiv.innerHTML = `
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-2xl font-bold" style="color: ${isCorrect ? 'var(--success)' : 'var(--danger)'}">${isCorrect ? 'âœ“' : 'âœ—'}</span>
                        <span class="text-xl font-bold">${score}ì  / ${question.points}ì </span>
                    </div>
                    <p class="mb-2"><strong>ì •ë‹µ:</strong> ${question.answer}</p>
                    ${question.explanation ? `<p class="mb-2"><strong>í•´ì„¤:</strong> ${question.explanation}</p>` : ''}
                    ${feedback ? `<p class="mb-2"><strong>í”¼ë“œë°±:</strong> ${feedback}</p>` : ''}
                `;
            }

            async function gradeAnswer(question, studentAnswer) {
                if (question.type === 'essay') {
                    // AI ì±„ì 
                    try {
                        const res = await fetch('/.netlify/functions/grade', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                question: question.content,
                                studentAnswer: studentAnswer,
                                rubric: question.rubric,
                                correctAnswer: question.answer,
                                type: 'essay'
                            })
                        });

                        // ì‘ë‹µ í…ìŠ¤íŠ¸ ë¨¼ì € ê°€ì ¸ì˜¤ê¸°
                        const responseText = await res.text();
                        
                        // ì‘ë‹µ ìƒíƒœ í™•ì¸
                        if (!res.ok) {
                            console.error('AI Grading API Error:', res.status, responseText);
                            
                            // JSON í˜•ì‹ì˜ ì—ëŸ¬ ì‘ë‹µì¸ì§€ í™•ì¸
                            let errorData;
                            try {
                                errorData = JSON.parse(responseText);
                                if (errorData.error && errorData.score !== undefined) {
                                    // ì—ëŸ¬ ì‘ë‹µì´ì§€ë§Œ scoreì™€ feedbackì´ í¬í•¨ëœ ê²½ìš°
                                    return {
                                        score: errorData.score || 0,
                                        feedback: errorData.feedback || errorData.error || 'ì±„ì  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
                                        isCorrect: false
                                    };
                                }
                            } catch (parseErr) {
                                // JSONì´ ì•„ë‹Œ ê²½ìš°
                            }
                            
                            throw new Error(`ì±„ì  API ì˜¤ë¥˜ (${res.status}): ${responseText.substring(0, 100)}`);
                        }

                        // JSON íŒŒì‹± ì‹œë„
                        let data;
                        try {
                            data = JSON.parse(responseText);
                        } catch (parseError) {
                            console.error('Failed to parse JSON response:', parseError);
                            console.error('Response text:', responseText.substring(0, 500));
                            throw new Error('ì±„ì  ì„œë²„ ì‘ë‹µì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        }
                        
                        // ì‘ë‹µ ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
                        if (!data || typeof data !== 'object') {
                            throw new Error('ì±„ì  ì‘ë‹µ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                        }
                        
                        // ì—ëŸ¬ í•„ë“œê°€ ìˆì§€ë§Œ scoreì™€ feedbackë„ ìˆëŠ” ê²½ìš° ì²˜ë¦¬
                        if (data.error && data.score === undefined) {
                            throw new Error(data.error || 'ì±„ì  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        }

                        return {
                            score: typeof data.score === 'number' ? data.score : 0,
                            feedback: typeof data.feedback === 'string' ? data.feedback : 'ì±„ì  ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                            isCorrect: (typeof data.score === 'number' ? data.score : 0) >= question.points * 0.8
                        };
                    } catch (e) {
                        console.error('AI Grading Error', e);
                        return {
                            score: 0,
                            feedback: "AI ì±„ì  ì‹¤íŒ¨: " + (e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'),
                            isCorrect: false
                        };
                    }
                } else if (question.type === 'choice') {
                    // ì„ íƒí˜• ì±„ì  - ë²ˆí˜¸, ë‚´ìš©, ì„ íƒì§€ ì¸ë±ìŠ¤ ëª¨ë‘ ì§€ì›
                    const studentAns = studentAnswer.trim();
                    const correctAns = question.answer.trim();

                    // 1. ì§ì ‘ ë‚´ìš© ë¹„êµ
                    if (studentAns === correctAns) {
                        return {
                            score: question.points,
                            feedback: "ì •ë‹µì…ë‹ˆë‹¤!",
                            isCorrect: true
                        };
                    }

                    // 2. ì„ íƒì§€ ì¸ë±ìŠ¤ë¡œ ë¹„êµ
                    const options = question.options || [];
                    const studentIndex = options.findIndex(opt => opt === studentAns);
                    const correctIndex = options.findIndex(opt => opt === correctAns);

                    if (studentIndex !== -1 && correctIndex !== -1 && studentIndex === correctIndex) {
                        return {
                            score: question.points,
                            feedback: "ì •ë‹µì…ë‹ˆë‹¤!",
                            isCorrect: true
                        };
                    }

                    // 3. ë²ˆí˜¸ë¡œ ë¹„êµ (ì •ë‹µì´ "1", "2" ê°™ì€ ê²½ìš°)
                    const numPattern = /^(\d+)$/;
                    if (numPattern.test(correctAns)) {
                        const correctNum = parseInt(correctAns);
                        if (studentIndex === correctNum - 1) {
                            return {
                                score: question.points,
                                feedback: "ì •ë‹µì…ë‹ˆë‹¤!",
                                isCorrect: true
                            };
                        }
                    }

                    // ì˜¤ë‹µ ì²˜ë¦¬
                    return {
                        score: 0,
                        feedback: `ì˜¤ë‹µì…ë‹ˆë‹¤. ì •ë‹µ: ${correctAns}`,
                        isCorrect: false
                    };
                } else {
                    // ë‹¨ë‹µí˜• ì¦‰ì‹œ ì±„ì 
                    const isCorrect = studentAnswer.trim() === question.answer.trim();
                    return {
                        score: isCorrect ? question.points : 0,
                        feedback: isCorrect ? "ì •ë‹µì…ë‹ˆë‹¤!" : `ì˜¤ë‹µì…ë‹ˆë‹¤. ì •ë‹µ: ${question.answer}`,
                        isCorrect: isCorrect
                    };
                }
            }

            async function submitQuiz() {
                const sid = document.getElementById('student-id').value;
                const sname = document.getElementById('student-name').value;
                const email = document.getElementById('student-email').value || '';
                const wantFeedback = document.getElementById('request-feedback').checked;

                if (wantFeedback && !email) {
                    alert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                // Collect answers - ì¤‘ë³µ ì œê±°ë¥¼ ìœ„í•´ Set ì‚¬ìš©
                const answeredQuestions = new Set();
                const answers = [];

                // Radio ë²„íŠ¼ ì²˜ë¦¬ (ê° ë¬¸ì œë‹¹ í•˜ë‚˜ë§Œ)
                studentQuestions.forEach(q => {
                    if (q.type === 'choice') {
                        const checkedRadio = document.querySelector(`input[name="q_${q.id}"]:checked`);
                        if (checkedRadio && !answeredQuestions.has(q.id)) {
                            answers.push({
                                qId: q.id,
                                answer: checkedRadio.value
                            });
                            answeredQuestions.add(q.id);
                        }
                    } else {
                        // Textareaë‚˜ input ì²˜ë¦¬
                        const input = document.querySelector(`[name="q_${q.id}"]`);
                        if (input && input.value && !answeredQuestions.has(q.id)) {
                            answers.push({
                                qId: q.id,
                                answer: input.value
                            });
                            answeredQuestions.add(q.id);
                        }
                    }
                });

                const timestamp = new Date().toISOString();

                try {
                    const btn = document.querySelector('button[onclick="submitQuiz()"]');
                    const originalText = btn.innerText;
                    btn.innerText = "ì œì¶œ ì¤‘...";
                    btn.disabled = true;

                    // Submit answers and grade immediately
                    for (const a of answers) {
                        const question = studentQuestions.find(q => q.id == a.qId);
                        if (!question) continue;

                        // Show loading
                        showLoadingAnimation(a.qId);

                        // Submit to sheet (spreadsheetId í¬í•¨ â†’ ë¬¸ì œê°€ ì €ì¥ëœ ë™ì¼ ì‹œíŠ¸ì˜ answer ì‹œíŠ¸ì— ì €ì¥)
                        const payload = {
                            timestamp,
                            sid,
                            sname,
                            email,
                            qId: a.qId,
                            answer: a.answer,
                            spreadsheetId: spreadsheetId
                        };

                        await fetch(getAppsScriptUrl(), {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: {
                                'Content-Type': 'text/plain'
                            },
                            body: JSON.stringify(payload)
                        });

                        // Grade immediately
                        const gradingResult = await gradeAnswer(question, a.answer);
                        showGradingResult(a.qId, question, a.answer, gradingResult.score, gradingResult.feedback, gradingResult.isCorrect);

                        // Save all grading results to SCORE sheet (including 0 scores)
                        // This ensures the displayed score matches the saved score
                        // ìœ í˜•ì„ í•œê¸€ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥
                        const typeKorean = getQuestionTypeName(question.type);
                        await autoGradeAndSave(a.qId, sid, sname, gradingResult.score, gradingResult.feedback, typeKorean);
                    }

                    btn.innerText = originalText;
                    btn.disabled = false;
                    alert("ì œì¶œ ë° ì±„ì ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");

                } catch (err) {
                    console.error("Submission error", err);
                    alert("ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    const btn = document.querySelector('button[onclick="submitQuiz()"]');
                    btn.innerText = "ë‹µì•ˆ ì œì¶œí•˜ê¸°";
                    btn.disabled = false;
                }
            }

            // ì¤‘ë³µ ì €ì¥ ë°©ì§€ë¥¼ ìœ„í•œ ë½ ë©”ì»¤ë‹ˆì¦˜
            const savingScores = new Set(); // í˜„ì¬ ì €ì¥ ì¤‘ì¸ ì ìˆ˜ ì¶”ì 

            async function autoGradeAndSave(qId, sid, sname, score, feedback, type) {
                // ì¤‘ë³µ ì €ì¥ ë°©ì§€ë¥¼ ìœ„í•œ ê³ ìœ  í‚¤ ìƒì„±
                const saveKey = `${sid}_${qId}`;
                
                // ì´ë¯¸ ì €ì¥ ì¤‘ì¸ ê²½ìš° ëŒ€ê¸°
                if (savingScores.has(saveKey)) {
                    console.log(`Score save already in progress for ${saveKey}, skipping...`);
                    return;
                }

                // ì €ì¥ ì‹œì‘ í‘œì‹œ
                savingScores.add(saveKey);

                try {
                    // ìœ í˜•ì„ í•œê¸€ë¡œ ë³€í™˜ (ì•ˆì „ì¥ì¹˜)
                    const typeKorean = getQuestionTypeName(type);

                    // gapiê°€ ì‚¬ìš© ê°€ëŠ¥í•œ ê²½ìš° (êµì‚¬ ëŒ€ì‹œë³´ë“œ)
                    if (gapi.client.sheets && spreadsheetId) {
                        try {
                            // ê¸°ì¡´ ì ìˆ˜ê°€ ìˆëŠ”ì§€ í™•ì¸ (ì¤‘ë³µ ì €ì¥ ë°©ì§€)
                            const scoreRes = await gapi.client.sheets.spreadsheets.values.get({
                                spreadsheetId: spreadsheetId,
                                range: 'SCORE!A2:H'
                            });

                            if (scoreRes.result.values) {
                                // ì´ë¯¸ í•´ë‹¹ í•™ìƒê³¼ ë¬¸ì œì˜ ì ìˆ˜ê°€ ìˆëŠ”ì§€ í™•ì¸ (íƒ€ì… ì¼ì¹˜ë¥¼ ìœ„í•´ Stringìœ¼ë¡œ ë³€í™˜)
                                const existingScore = scoreRes.result.values.find(row => 
                                    String(row[1]) === String(sid) && String(row[3]) === String(qId)
                                );

                                if (existingScore) {
                                    // ê¸°ì¡´ ì ìˆ˜ê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸ (ì ìˆ˜, í”¼ë“œë°±, ìœ í˜• ëª¨ë‘ ì—…ë°ì´íŠ¸)
                                    const rowIndex = scoreRes.result.values.findIndex(row => 
                                        String(row[1]) === String(sid) && String(row[3]) === String(qId)
                                    ) + 2; // +2 because range starts at A2

                                    await gapi.client.sheets.spreadsheets.values.update({
                                        spreadsheetId: spreadsheetId,
                                        range: `SCORE!E${rowIndex}:G${rowIndex}`,
                                        valueInputOption: 'RAW',
                                        resource: {
                                            values: [[score, feedback, typeKorean]]
                                        }
                                    });
                                    console.log(`Updated score for ${sid}, Q${qId}: ${score}ì `);
                                    return;
                                }
                            }

                            // ìƒˆ ì ìˆ˜ ì €ì¥
                            await checkAndWriteHeader('SCORE', ["Timestamp", "StudentID", "Name", "Q_ID", "Score", "Feedback", "Type", "EmailStatus"]);

                            await gapi.client.sheets.spreadsheets.values.append({
                                spreadsheetId: spreadsheetId,
                                range: 'SCORE!A2',
                                valueInputOption: 'RAW',
                                resource: {
                                    values: [[
                                        new Date().toISOString(),
                                        sid,
                                        sname,
                                        qId,
                                        score,
                                        feedback,
                                        typeKorean, // í•œê¸€ë¡œ ì €ì¥
                                        '' // EmailStatus - ì´ˆê¸°ê°’ì€ ë¹ˆ ë¬¸ìì—´
                                    ]]
                                }
                            });
                            console.log(`Saved new score for ${sid}, Q${qId}: ${score}ì `);
                            return;
                        } catch (gapiErr) {
                            console.warn("gapi save failed, falling back to Apps Script:", gapiErr);
                            // gapi ì‹¤íŒ¨ ì‹œ Apps Scriptë¡œ í´ë°±
                        }
                    }

                    // Apps Scriptë¥¼ í†µí•œ ì €ì¥ (í•™ìƒ í™˜ê²½ ë˜ëŠ” gapi ì‹¤íŒ¨ ì‹œ)
                    if (!spreadsheetId) {
                        console.error("Cannot save score: spreadsheetId not available");
                        return;
                    }

                    try {
                        const response = await fetch(getAppsScriptUrl() + '?type=saveScore', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'text/plain',
                            },
                            body: JSON.stringify({
                                timestamp: new Date().toISOString(),
                                sid: sid,
                                sname: sname,
                                qId: qId,
                                score: score,
                                feedback: feedback,
                                type: typeKorean,
                                emailStatus: '',
                                spreadsheetId: spreadsheetId
                            })
                        });

                        const result = await response.json();
                        if (result.result === 'success') {
                            console.log(`Saved score via Apps Script for ${sid}, Q${qId}: ${score}ì  (${result.action})`);
                        } else {
                            throw new Error(result.error || 'Apps Script save failed');
                        }
                    } catch (appsScriptErr) {
                        console.error("Apps Script save error:", appsScriptErr);
                        throw appsScriptErr;
                    }
                } catch (err) {
                    console.error("Auto-grade save error", err);
                    throw err; // ì—ëŸ¬ë¥¼ ë‹¤ì‹œ throwí•˜ì—¬ í˜¸ì¶œìê°€ ì•Œ ìˆ˜ ìˆë„ë¡
                } finally {
                    // ì €ì¥ ì™„ë£Œ í›„ ë½ í•´ì œ
                    savingScores.delete(saveKey);
                }
            }

            // Initialize
            console.log("App Initialized");
            gapiLoaded();
            gisLoaded();

            // Check link on load
            window.onload = function () {
                setTimeout(checkForStudentLink, 1000); // Small delay to ensure logic loaded
            };
        </script>
        <!-- Theme Selector -->
        <div id="theme-selector">
            <select onchange="setTheme(this.value)" class="bg-transparent border-none outline-none text-xs p-1 m-0 mb-0"
                style="width: auto; height: auto;">
                <option value="dark">ğŸŒ™ Dark</option>
                <option value="light">â˜€ï¸ Light</option>
            </select>
        </div>
</body>

</html>

